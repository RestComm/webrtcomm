PrivateJainSipCallConnector=function(a,c,b){console.debug("PrivateJainSipCallConnector:PrivateJainSipCallConnector()");if(c instanceof WebRTCommCall){if(typeof(b)=="string"){this.sipCallId=b}else{this.sipCallId=new String(new Date().getTime())}this.clientConnector=a;this.webRTCommCall=c;this.webRTCommCall.id=this.sipCallId;this.configuration=undefined;this.resetSipContext()}else{throw"PrivateJainSipCallConnector:PrivateJainSipCallConnector(): bad arguments"}};PrivateJainSipCallConnector.prototype.SIP_INVITING_INITIAL_STATE="INVITING_INITIAL_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITING_STATE="INVITING_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITING_407_STATE="INVITING_407_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITING_ACCEPTED_STATE="INVITING_ACCEPTED_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITING_LOCAL_HANGINGUP_STATE="INVITING_LOCAL_HANGINGUP_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITING_LOCAL_HANGINGUP_407_STATE="INVITING_LOCAL_HANGINGUP_407_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITING_CANCELLING_STATE="INVITING_CANCELLING_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITING_ERROR_STATE="INVITING_ERROR_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITING_HANGUP_STATE="INVITING_HANGUP_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITING_CANCELLED_STATE="SIP_INVITING_CANCELLED_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITED_INITIAL_STATE="INVITED_INITIAL_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITED_ACCEPTED_STATE="INVITED_ACCEPTED_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITED_LOCAL_HANGINGUP_STATE="INVITED_LOCAL_HANGINGUP_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITED_LOCAL_HANGINGUP_407_STATE="INVITED_LOCAL_HANGINGUP_407_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITED_HANGUP_STATE="INVITED_HANGUP_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITED_ERROR_STATE="INVITED_ERROR_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITED_CANCELLED_STATE="INVITING_HANGUP_STATE";PrivateJainSipCallConnector.prototype.isOpened=function(){return((this.sipCallState==this.SIP_INVITING_ACCEPTED_STATE)||(this.sipCallState==this.SIP_INVITED_ACCEPTED_STATE))};PrivateJainSipCallConnector.prototype.getId=function(){return this.sipCallId};PrivateJainSipCallConnector.prototype.open=function(a){console.debug("PrivateJainSipCallConnector:open()");if(this.sipCallState==undefined){if(typeof(a)=="object"){if(this.checkConfiguration(a)==true){this.sipCallState=this.SIP_INVITING_INITIAL_STATE;this.configuration=a}else{console.error("PrivateJainSipCallConnector:open(): bad configuration");throw"PrivateJainSipCallConnector:open(): bad configuration"}}else{this.sipCallState=SIP_INVITED_INITIAL_STATE}}else{console.error("PrivateJainSipCallConnector:open(): bad state, unauthorized action");throw"PrivateJainSipCallConnector:open(): bad state, unauthorized action"}};PrivateJainSipCallConnector.prototype.close=function(){console.debug("PrivateJainSipCallConnector:close(): this.sipCallState="+this.sipCallState);if(this.sipCallState!=undefined){try{if(this.sipCallState==this.SIP_INITIAL_INVITING_STATE){this.resetSipContext();this.clientConnector.removeCallConnector(this.sipCallId);this.webRTCommCall.onPrivateCallConnectorCallClosedEvent()}else{if(this.sipCallState==this.SIP_INVITING_STATE||this.sipCallState==this.SIP_INVITING_407_STATE){this.jainSipInvitingCancelRequest=this.jainSipInvitingTransaction.createCancel();this.jainSipInvitingCancelRequest.addHeader(this.clientConnector.jainSipContactHeader);this.jainSipInvitingCancelTransaction=this.clientConnector.jainSipProvider.getNewClientTransaction(this.jainSipInvitingCancelRequest);this.jainSipInvitingCancelTransaction.sendRequest();this.sipCallState=this.SIP_INVITING_CANCELLING_STATE}else{if(this.sipCallState==this.SIP_INVITING_ACCEPTED_STATE){var c=this.jainSipInvitingDialog.createRequest("BYE");c.removeHeader("Contact");c.removeHeader("User-Agent");c.addHeader(this.clientConnector.jainSipContactHeader);var a=this.clientConnector.jainSipProvider.getNewClientTransaction(c);this.jainSipInvitingDialog.sendRequest(a);this.sipCallState=this.SIP_INVITING_LOCAL_HANGINGUP_STATE;this.webRTCommCall.onPrivateCallConnectorCallClosedEvent()}else{if(this.sipCallState==this.SIP_INVITED_INITIAL_STATE){var d=this.jainSipInvitedRequest.createResponse(480,"Temporarily Unavailable");d.addHeader(this.clientConnector.jainSipContactHeader);this.jainSipInvitedTransaction.sendResponse(d);this.resetSipContext();this.clientConnector.removeCallConnector(this.sipCallId)}else{if(this.sipCallState==this.SIP_INVITED_ACCEPTED_STATE){var c=this.jainSipInvitedDialog.createRequest("BYE");c.removeHeader("Contact");c.removeHeader("User-Agent");c.addHeader(this.clientConnector.jainSipContactHeader);var a=this.clientConnector.jainSipProvider.getNewClientTransaction(c);this.jainSipInvitedDialog.sendRequest(a);this.sipCallState=this.SIP_INVITED_LOCAL_HANGINGUP_STATE}else{this.resetSipContext();this.clientConnector.removeCallConnector(this.sipCallId);this.webRTCommCall.onPrivateCallConnectorCallClosedEvent()}}}}}}catch(b){console.error("PrivateJainSipCallConnector:close(): catched exception:"+b);this.resetSipContext();this.clientConnector.removeCallConnector(this.sipCallId);this.webRTCommCall.onPrivateCallConnectorCallClosedEvent()}}};PrivateJainSipCallConnector.prototype.reject=function(){console.debug("PrivateJainSipCallConnector:reject()");if(this.sipCallState==this.SIP_INVITED_INITIAL_STATE){try{var a=this.jainSipInvitedRequest.createResponse(486,"Busy here");a.addHeader(this.clientConnector.jainSipContactHeader);this.jainSipInvitedTransaction.sendResponse(a)}catch(b){console.error("PrivateJainSipCallConnector:reject(): catched exception:"+b)}this.close()}else{console.error("PrivateJainSipCallConnector:reject(): bad state, unauthorized action");throw"PrivateJainSipCallConnector:reject(): bad state, unauthorized action"}};PrivateJainSipCallConnector.prototype.checkConfiguration=function(b){console.debug("PrivateJainSipCallConnector:checkConfiguration()");var a=true;return a};PrivateJainSipCallConnector.prototype.resetSipContext=function(){console.debug("PrivateJainSipCallConnector:resetSipContext()");this.sipCallState=undefined;this.sdpOffer=undefined;this.jainSipInvitingSentRequest=undefined;this.jainSipInvitingDialog=undefined;this.jainSipInvitingTransaction=undefined;this.jainSipInvitedReceivedRequest=undefined;this.jainSipInvitedDialog=undefined;this.jainSipInvitedTransaction=undefined};PrivateJainSipCallConnector.prototype.invite=function(a){console.debug("PrivateJainSipCallConnector:invite()");this.sdpOffer=a;this.sendSipInviteRequest(a);this.sipCallState=this.SIP_INVITING_STATE};PrivateJainSipCallConnector.prototype.accept=function(a){console.debug("PrivateJainSipCallConnector:accept()");var b=this.jainSipInvitedRequest.createResponse(200,"OK");b.addHeader(this.clientConnector.jainSipContactHeader);b.setMessageContent("application","sdp",a);this.jainSipInvitedTransaction.sendResponse(b);this.sipCallState=this.SIP_INVITED_ACCEPTED_STATE};PrivateJainSipCallConnector.prototype.onJainSipClientConnectorSipRequestEvent=function(a){console.debug("PrivateJainSipCallConnector:onJainSipClientConnectorSipRequestEvent()");if(this.jainSipInvitingDialog!=undefined){this.processInvitingSipRequestEvent(a)}else{if(this.jainSipInvitedDialog!=undefined){this.processInvitedSipRequestEvent(a)}else{this.processInvitedSipRequestEvent(a)}}};PrivateJainSipCallConnector.prototype.onJainSipClientConnectorSipResponseEvent=function(a){console.debug("PrivateJainSipCallConnector:onJainSipClientConnectorSipResponseEvent()");if(this.jainSipInvitingDialog!=undefined){this.processInvitingSipResponseEvent(a)}else{if(this.jainSipInvitedDialog!=undefined){this.processInvitedSipResponseEvent(a)}else{console.warn("PrivateJainSipCallConnector:onJainSipClientConnectorSipResponseEvent(): response ignored")}}};PrivateJainSipCallConnector.prototype.onJainSipClientConnectorSipTimeoutEvent=function(a){console.debug("PrivateJainSipCallConnector:onJainSipClientConnectorSipTimeoutEvent()");this.close()};PrivateJainSipCallConnector.prototype.processInvitingSipRequestEvent=function(a){console.debug("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): this.sipCallState="+this.sipCallState);var c=a.getRequest();var d=c.getMethod();if(this.sipCallState==this.SIP_INVITING_INITIAL_STATE){console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): bad state, SIP request ignored")}else{if(this.sipCallState==this.SIP_INVITING_STATE){console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): bad state, SIP request ignored")}else{if(this.sipCallState==this.SIP_INVITING_407_STATE){console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): bad state, SIP request ignored")}else{if(this.sipCallState==this.SIP_INVITING_FAILED_STATE){console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): bad state, SIP request ignored")}else{if(this.sipCallState==this.SIP_INVITING_ACCEPTED_STATE){if(d=="BYE"){try{var e=c.createResponse(200,"OK");e.addHeader(this.clientConnector.jainSipContactHeader);a.getServerTransaction().sendResponse(e);this.sipCallState=this.SIP_INVITING_HANGUP_STATE}catch(b){console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): catched exception exception:"+b)}this.webRTCommCall.onPrivateCallConnectorCallHangupEvent();this.close()}else{console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): bad state, SIP request ignored")}}else{console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): bad state, SIP request ignored")}}}}}};PrivateJainSipCallConnector.prototype.sendSipInviteRequest=function(){console.debug("PrivateJainSipCallConnector:sendSipInviteRequest()");var f=this.webRTCommCall.getCalleePhoneNumber();if(f.indexOf("@")==-1){f+="@"+this.clientConnector.configuration.sipDomain}var a=this.clientConnector.configuration.sipUserName+"@"+this.clientConnector.configuration.sipDomain;var k=this.clientConnector.jainSipHeaderFactory.createCSeqHeader(1,"INVITE");var p=this.clientConnector.jainSipHeaderFactory.createCallIdHeader(this.sipCallId);var h=this.clientConnector.jainSipHeaderFactory.createMaxForwardsHeader(70);var d=this.clientConnector.jainSipAddressFactory.createSipURI_user_host(null,f);var j=this.clientConnector.jainSipHeaderFactory.createHeaders("Allow: INVITE,ACK,CANCEL,BYE");var b=this.clientConnector.jainSipAddressFactory.createSipURI_user_host(null,a);var g=this.clientConnector.jainSipAddressFactory.createAddress_name_uri(this.configuration.displayName,b);if(this.configuration.displayName){g.setDisplayName(this.configuration.displayName)}else{if(this.clientConnector.configuration.sipDisplayName){g.setDisplayName(this.clientConnector.configuration.sipDisplayName)}}var n=new Date().getTime();var i=this.clientConnector.jainSipHeaderFactory.createFromHeader(g,n);var m=this.clientConnector.jainSipAddressFactory.createSipURI_user_host(null,f);var c=this.clientConnector.jainSipAddressFactory.createAddress_name_uri(null,m);var e=this.clientConnector.jainSipHeaderFactory.createToHeader(c,null);var l=this.clientConnector.jainSipListeningPoint.getViaHeader();var o=this.clientConnector.jainSipHeaderFactory.createContentTypeHeader("application","sdp");this.jainSipInvitingRequest=this.clientConnector.jainSipMessageFactory.createRequest(d,"INVITE",p,k,i,e,l,h,o,this.sdpOffer);this.clientConnector.jainSipMessageFactory.addHeader(this.jainSipInvitingRequest,j);this.clientConnector.jainSipMessageFactory.addHeader(this.jainSipInvitingRequest,this.clientConnector.jainSipContactHeader);this.jainSipInvitingTransaction=this.clientConnector.jainSipProvider.getNewClientTransaction(this.jainSipInvitingRequest);this.jainSipInvitingRequest.setTransaction(this.jainSipInvitingTransaction);this.jainSipInvitingDialog=this.jainSipInvitingTransaction.getDialog();this.jainSipInvitingTransaction.sendRequest()};PrivateJainSipCallConnector.prototype.sendAuthenticatedSipInviteRequest=function(d){console.debug("PrivateJainSipCallConnector:sendAuthenticatedSipInviteRequest()");this.jainSipInvitingRequest.removeHeader("Authorization");var a=new SIPRequest();a.setMethod(this.jainSipInvitingRequest.getMethod());a.setRequestURI(this.jainSipInvitingRequest.getRequestURI());var c=this.jainSipInvitingRequest.getHeaders();for(var e=0;e<c.length;e++){a.addHeader(c[e])}var b=new Number(this.jainSipInvitingRequest.getCSeq().getSeqNumber());a.getCSeq().setSeqNumber(b+1);a.setCallId(this.jainSipInvitingRequest.getCallId());a.setVia(this.clientConnector.jainSipListeningPoint.getViaHeader());a.setFrom(this.jainSipInvitingRequest.getFrom());a.setTo(this.jainSipInvitingRequest.getTo());a.setMaxForwards(this.jainSipInvitingRequest.getMaxForwards());if(this.jainSipInvitingRequest.getContent()!=null){var f=this.jainSipInvitingRequest.getContent();var g=this.jainSipInvitingRequest.getContentTypeHeader();a.setContent(f,g)}this.jainSipInvitingRequest=a;this.clientConnector.jainSipMessageFactory.addHeader(this.jainSipInvitingRequest,d);this.jainSipInvitingTransaction=this.clientConnector.jainSipProvider.getNewClientTransaction(this.jainSipInvitingRequest);this.jainSipInvitingRequest.setTransaction(this.jainSipInvitingransaction);this.jainSipInvitingTransaction.sendRequest()};PrivateJainSipCallConnector.prototype.processInvitingSipResponseEvent=function(b){console.debug("PrivateJainSipCallConnector:processInvitingSipResponseEvent(): this.sipCallState="+this.sipCallState);var g=b.getResponse();var d=parseInt(g.getStatusCode());if(this.sipCallState==this.SIP_INVITING_STATE){if(d<200){if(d==180){this.webRTCommCall.onPrivateCallConnectorCallRingingBackEvent()}else{if(d==183){this.webRTCommCall.onPrivateCallConnectorCallInProgressEvent()}}console.debug("PrivateJainSipCallConnector:processInvitingSipResponseEvent(): 1XX response ignored")}else{if(d==407){var i=this.clientConnector.jainSipHeaderFactory.createAuthorizationHeader(g,this.jainSipInvitingRequest,this.clientConnector.configuration.sipPassword,this.clientConnector.configuration.sipLogin);this.sendAuthenticatedSipInviteRequest(i);this.sipCallState=this.SIP_INVITING_407_STATE}else{if(d==200){this.jainSipInvitingDialog=b.getOriginalTransaction().getDialog();try{this.jainSipInvitingDialog.setRemoteTarget(g.getHeader("Contact"));var e=this.jainSipInvitingTransaction.createAck();e.addHeader(this.clientConnector.jainSipContactHeader);this.jainSipInvitingDialog.sendAck(e);this.sipCallState=this.SIP_INVITING_ACCEPTED_STATE}catch(c){console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): catched exception, exception:"+c)}try{var f=g.getContent();this.webRTCommCall.onPrivateCallConnectorRemoteSdpAnswerEvent(f)}catch(c){console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): catched exception, exception:"+c);this.webRTCommCall.onPrivateCallConnectorCallOpenErrorEvent(c);this.close()}}else{console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): SIP INVITE failed:"+g.getStatusCode()+"  "+g.getStatusLine().toString());this.sipCallState=this.SIP_INVITING_ERROR_STATE;this.webRTCommCall.onPrivateCallConnectorCallOpenErrorEvent(g.getStatusLine().getReasonPhrase());this.close()}}}}else{if(this.sipCallState==this.SIP_INVITING_CANCELLING_STATE){this.sipCallState=this.SIP_INVITING_CANCELLED_STATE;this.close()}else{if(this.sipCallState==this.SIP_INVITING_407_STATE){if(d<200){console.debug("PrivateJainSipCallConnector:processInvitingSipResponseEvent(): 1XX response ignored")}else{if(d==200){this.jainSipInvitingDialog=b.getOriginalTransaction().getDialog();try{this.jainSipInvitingDialog.setRemoteTarget(g.getHeader("Contact"));var e=this.jainSipInvitingTransaction.createAck();e.addHeader(this.clientConnector.jainSipContactHeader);this.jainSipInvitingDialog.sendAck(e);this.sipCallState=this.SIP_INVITING_ACCEPTED_STATE}catch(c){console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): catched exception, exception:"+c)}try{var f=g.getContent();this.webRTCommCall.onPrivateCallConnectorRemoteSdpAnswerEvent(f)}catch(c){console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): catched exception, exception:"+c);this.webRTCommCall.onPrivateCallConnectorCallOpenErrorEvent(c);this.close()}}else{this.sipCallState=this.SIP_INVITING_ERROR_STATE;this.webRTCommCall.onPrivateCallConnectorCallOpenErrorEvent(g.getStatusLine().getReasonPhrase());this.close()}}}else{if(this.sipCallState==this.SIP_INVITING_FAILED_STATE){console.error("PrivateJainSipCallConnector:processInvitingSipResponseEvent(): bad state, SIP response ignored")}else{if(this.sipCallState==this.SIP_INVITING_ACCEPTED_STATE){console.error("PrivateJainSipCallConnector:processInvitingSipResponseEvent(): bad state, SIP response ignored")}else{if(this.sipCallState==this.SIP_INVITING_LOCAL_HANGINGUP_STATE){if(d==407){try{var a=this.jainSipInvitingDialog.createRequest("BYE");var h=this.clientConnector.jainSipProvider.getNewClientTransaction(a);var i=this.clientConnector.jainSipHeaderFactory.createAuthorizationHeader(g,a,this.clientConnector.configuration.sipPassword,this.clientConnector.configuration.sipLogin);this.clientConnector.jainSipMessageFactory.addHeader(a,i);this.jainSipInvitingDialog.sendRequest(h);this.sipCallState=this.SIP_INVITING_HANGINGUP_407_STATE}catch(c){console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): catched exception, exception:"+c);this.close()}}else{this.close()}}else{if(this.sipCallState==this.SIP_INVITING_LOCAL_HANGINGUP_407_STATE){this.close()}else{console.error("PrivateJainSipCallConnector:processInvitingSipResponseEvent(): bad state, SIP response ignored")}}}}}}}};PrivateJainSipCallConnector.prototype.processInvitedSipRequestEvent=function(c){console.debug("PrivateJainSipCallConnector:processInvitedSipRequestEvent(): this.sipCallState="+this.sipCallState);var a=c.getRequest();var e=a.getMethod();var d=a.getHeader("From");if(this.sipCallState==this.SIP_INVITED_INITIAL_STATE){if(e=="INVITE"){try{this.jainSipInvitedRequest=a;this.jainSipInvitedTransaction=c.getServerTransaction();this.jainSipInvitedDialog=c.getServerTransaction().getDialog();var j=a.createResponse(180,"Ringing");j.addHeader(this.clientConnector.jainSipContactHeader);c.getServerTransaction().sendResponse(j)}catch(b){console.error("PrivateJainSipCallConnector:processInvitedSipRequestEvent(): catched exception, exception:"+b)}this.webRTCommCall.onPrivateCallConnectorRemoteSdpOfferEvent(this.jainSipInvitedRequest.getContent());var h=d.getAddress().getURI().getUser();var i=d.getAddress().getDisplayName();this.webRTCommCall.onPrivateCallConnectorCallRingingEvent(h,i)}else{if(e=="CANCEL"){try{var f=a.createResponse(200,"OK");f.addHeader(this.clientConnector.jainSipContactHeader);c.getServerTransaction().sendResponse(f);var g=this.jainSipInvitedRequest.createResponse(487,"(Request Cancelled)");this.jainSipInvitedTransaction.sendMessage(g);this.sipCallState=this.SIP_INVITED_CANCELLED_STATE}catch(b){console.error("PrivateJainSipCallConnector:processInvitedSipRequestEvent(): catched exception, exception:"+b)}this.webRTCommCall.onPrivateCallConnectorCallHangupEvent();this.close()}else{console.error("PrivateJainSipCallConnector:processInvitedSipRequestEvent(): bad state, SIP request ignored")}}}else{if(this.sipCallState==this.SIP_INVITED_ACCEPTED_STATE){if(e=="BYE"){try{var f=a.createResponse(200,"OK");f.addHeader(this.clientConnector.jainSipContactHeader);c.getServerTransaction().sendResponse(f);this.sipCallState=this.SIP_INVITED_HANGUP_STATE}catch(b){console.error("PrivateJainSipCallConnector:processInvitedSipRequestEvent(): catched exception exception:"+b)}this.webRTCommCall.onPrivateCallConnectorCallHangupEvent();this.close()}else{if(e=="ACK"){this.jainSipInvitedDialog=c.getServerTransaction().getDialog()}else{console.error("PrivateJainSipCallConnector:processInvitedSipRequestEvent(): bad state, SIP request ignored")}}}else{if(this.sipCallState==this.SIP_INVITED_LOCAL_HANGINGUP_STATE){console.error("PrivateJainSipCallConnector:processInvitedSipRequestEvent(): bad state, SIP request ignored")}else{if(this.sipCallState==this.SIP_INVITED_LOCAL_HANGINGUP_407_STATE){console.error("PrivateJainSipCallConnector:processInvitedSipRequestEvent(): bad state, SIP request ignored")}}}}};PrivateJainSipCallConnector.prototype.processInvitedSipResponseEvent=function(f){console.debug("PrivateJainSipCallConnector:processInvitedSipResponseEvent(): this.invitingState="+this.invitingState);var g=f.getResponse();var e=parseInt(g.getStatusCode());if(this.sipCallState==this.SIP_INVITED_STATE){console.error("PrivateJainSipCallConnector:processInvitedSipResponseEvent(): bad state, SIP response ignored")}else{if(this.sipCallState==this.SIP_INVITED_ACCEPTED_STATE){console.error("PrivateJainSipCallConnector:processInvitedSipResponseEvent(): bad state, SIP response ignored")}else{if(this.sipCallState==this.SIP_INVITED_LOCAL_HANGINGUP_STATE){if(e==407){try{var d=this.jainSipInvitedDialog.createRequest("BYE");var a=this.jainSipProvider.getNewClientTransaction(d);var b=this.jainSipHeaderFactory.createAuthorizationHeader(g,d,this.configuration.sipPassword,this.configuration.sipLogin);this.jainSipMessageFactory.addHeader(d,b);d.addHeader(this.clientConnector.jainSipContactHeader);this.jainSipInvitedDialog.sendRequest(a);this.sipCallState=this.SIP_INVITED_HANGINGUP_407_STATE}catch(c){console.error("PrivateJainSipCallConnector:processInvitedSipResponseEvent(): catched exception, exception:"+c);this.close()}}else{this.close()}}else{if(this.sipCallState==this.SIP_INVITED_LOCAL_HANGINGUP_407_STATE){this.close()}else{console.error("PrivateJainSipCallConnector:processInvitedSipResponseEvent(): bad state, SIP request ignored")}}}}};PrivateJainSipClientConnector=function(a){console.debug("PrivateJainSipClientConnector:PrivateJainSipClientConnector()");if(a instanceof WebRTCommClient){this.webRTCommClient=a;this.reset()}else{throw"PrivateJainSipClientConnector:PrivateJainSipClientConnector(): bad arguments"}};PrivateJainSipClientConnector.prototype.SIP_ALLOW_HEADER="Allow: INVITE,ACK,CANCEL,BYE, OPTIONS";PrivateJainSipClientConnector.prototype.SIP_UNREGISTERED_STATE="SIP_UNREGISTERED_STATE";PrivateJainSipClientConnector.prototype.SIP_REGISTERING_STATE="SIP_REGISTERING_STATE";PrivateJainSipClientConnector.prototype.SIP_REGISTER_REFRESHING_STATE="SIP_REGISTER_REFRESHING_STATE";PrivateJainSipClientConnector.prototype.SIP_REGISTERING_401_STATE="SIP_REGISTERING_401_STATE";PrivateJainSipClientConnector.prototype.SIP_REGISTERED_STATE="SIP_REGISTERED_STATE";PrivateJainSipClientConnector.prototype.SIP_UNREGISTERING_401_STATE="SIP_UNREGISTERING_401_STATE";PrivateJainSipClientConnector.prototype.SIP_UNREGISTERING_STATE="SIP_UNREGISTERING_STATE";PrivateJainSipClientConnector.prototype.SIP_SESSION_EXPIRATION_TIMER=3600;PrivateJainSipClientConnector.prototype.isOpened=function(){return this.openedFlag};PrivateJainSipClientConnector.prototype.open=function(f){console.debug("PrivateJainSipClientConnector:open()");try{if(typeof(f)=="object"){if(this.openedFlag==false){if(this.checkConfiguration(f)==true){this.configuration=f;this.jainSipFactory=new SipFactory();this.jainSipStack=this.jainSipFactory.createSipStack(this.configuration.sipUserAgent);this.jainSipListeningPoint=this.jainSipStack.createListeningPoint(this.configuration.sipOutboundProxy);this.jainSipProvider=this.jainSipStack.createSipProvider(this.jainSipListeningPoint);this.jainSipProvider.addSipListener(this);this.jainSipHeaderFactory=this.jainSipFactory.createHeaderFactory();this.jainSipAddressFactory=this.jainSipFactory.createAddressFactory();this.jainSipMessageFactory=this.jainSipFactory.createMessageFactory();this.jainSipContactHeader=this.jainSipListeningPoint.createContactHeader(this.configuration.sipUserName);if(this.configuration.sipUserAgentCapabilities){this.jainSipContactHeader.setParameter(this.configuration.sipUserAgentCapabilities,null)}if(this.configuration.sipUriContactParameters){try{var e=this.jainSipContactHeader.getAddress().getURI();var d=this.configuration.sipUriContactParameters.split(";");for(var c=0;c<d.length;c++){var a=d[c].split("=");e.uriParms.set_nv(new NameValue(a[0],a[1]))}}catch(b){console.error("PrivateJainSipClientConnector:open(): catched exception:"+b)}}this.jainSipMessageFactory.setDefaultUserAgentHeader(this.jainSipHeaderFactory.createUserAgentHeader(this.jainSipStack.getUserAgent()));this.jainSipStack.start()}else{console.error("PrivateJainSipClientConnector:open(): bad configuration");throw"PrivateJainSipClientConnector:open(): bad configuration"}}else{console.error("PrivateJainSipClientConnector:open(): bad state, unauthorized action");throw"PrivateJainSipClientConnector:open(): bad state, unauthorized action"}}else{console.error("PrivateJainSipClientConnector:open(): bad argument, check API documentation");throw"PrivateJainSipClientConnector:open(): bad argument, check API documentation"}}catch(b){this.reset();console.error("PrivateJainSipClientConnector:open(): catched exception:"+b);throw b}};PrivateJainSipClientConnector.prototype.close=function(){console.debug("PrivateJainSipClientConnector:close()");try{if(this.openedFlag==true){for(var a in this.callConnectors){var c=this.findCallConnector(a);if(c.isOpened()){c.close()}}if(this.configuration.sipRegisterMode==true){if(this.sipRegisterState==this.SIP_REGISTERED_STATE){this.sipUnregisterPendingFlag=false;this.sipRegisterState=this.SIP_UNREGISTERING_STATE;if(this.sipRegisterRefreshTimer){clearTimeout(this.sipRegisterRefreshTimer)}this.sendNewSipRegisterRequest(0)}else{this.sipUnregisterPendingFlag=true}}else{this.reset();this.webRTCommClient.onPrivateClientConnectorClosedEvent()}}else{console.error("PrivateJainSipClientConnector:close(): bad state, unauthorized action");throw"PrivateJainSipClientConnector:close(): bad state, unauthorized action"}}catch(b){console.error("PrivateJainSipClientConnector:close(): catched exception:"+b);throw b}};PrivateJainSipClientConnector.prototype.createPrivateCallConnector=function(b,a){console.debug("PrivateJainSipClientConnector:createPrivateCallConnector()");try{if(b instanceof WebRTCommCall){if(this.openedFlag==true){var d=new PrivateJainSipCallConnector(this,b,a);d.clientConnector=this;this.callConnectors[d.sipCallId]=d;return d}else{console.error("PrivateJainSipClientConnector:createPrivateCallConnector(): bad state, unauthorized action");throw"PrivateJainSipClientConnector:createPrivateCallConnector(): bad state, unauthorized action"}}else{console.error("PrivateJainSipClientConnector:createPrivateCallConnector(): bad argument, check API documentation");throw"PrivateJainSipClientConnector:createPrivateCallConnector(): bad argument, check API documentation"}}catch(c){console.error("PrivateJainSipClientConnector:createPrivateCallConnector(): catched exception:"+c);throw c}};PrivateJainSipClientConnector.prototype.findCallConnector=function(a){console.debug("PrivateJainSipClientConnector:findCallConnector(): sipCallId="+a);return this.callConnectors[a]};PrivateJainSipClientConnector.prototype.removeCallConnector=function(a){console.debug("PrivateJainSipClientConnector:removeCallConnector(): sipCallId="+a);delete this.callConnectors.sipCallId};PrivateJainSipClientConnector.prototype.reset=function(){console.debug("PrivateJainSipClientConnector:reset()");this.openedFlag=false;this.configuration=undefined;this.resetSipRegisterContext();this.callConnectors={}};PrivateJainSipClientConnector.prototype.resetSipRegisterContext=function(){console.debug("PrivateJainSipClientConnector:resetSipRegisterContext()");if(this.sipRegisterRefreshTimer!=undefined){clearTimeout(this.sipRegisterRefreshTimer)}this.sipRegisterState=this.SIP_UNREGISTERED_STATE;this.sipRegisterRefreshTimer=undefined;this.sipRegisterAuthenticatedFlag=false;this.jainSipRegisterRequest=undefined;this.jainSipRegisterTransaction=undefined;this.jainSipRegisterDialog=undefined;this.sipUnregisterPendingFlag=false};PrivateJainSipClientConnector.prototype.checkConfiguration=function(c){console.debug("PrivateJainSipClientConnector:checkConfiguration()");try{var a=true;if(c.sipUserAgent==undefined||c.sipUserAgent.length==0){a=false;console.error("PrivateJainSipClientConnector:checkConfiguration(): missing configuration parameter sipUserAgent")}if(c.sipOutboundProxy==undefined||c.sipOutboundProxy.length==0){a=false;console.error("PrivateJainSipClientConnector:checkConfiguration(): missing configuration parameter sipOutboundProxy")}if(c.sipDomain==undefined||c.sipDomain.length==0){a=false;console.error("PrivateJainSipClientConnector:checkConfiguration(): missing configuration parameter sipDomain")}if(c.sipUserName==undefined||c.sipUserName.length==0){a=false;console.error("PrivateJainSipClientConnector:checkConfiguration(): missing configuration parameter sipUserName")}if(c.sipRegisterMode==undefined||c.sipRegisterMode.length==0){a=false;console.error("PrivateJainSipClientConnector:checkConfiguration(): missing configuration parameter sipRegisterMode")}if(c.sipLogin!=undefined&&c.sipLogin==""){c.sipLogin=undefined}if(c.sipPassword!=undefined&&c.sipPassword==""){c.sipPassword=undefined}if(c.sipUserAgentCapabilities!=undefined&&c.sipUserAgentCapabilities==""){c.sipUserAgentCapabilities=undefined}console.debug("PrivateJainSipClientConnector:checkConfiguration(): configuration.sipUserAgent:"+c.sipUserAgent);console.debug("PrivateJainSipClientConnector:checkConfiguration(): configuration.sipUserAgentCapabilities:"+c.sipUserAgentCapabilities);console.debug("PrivateJainSipClientConnector:checkConfiguration(): configuration.sipOutboundProxy:"+c.sipOutboundProxy);console.debug("PrivateJainSipClientConnector:checkConfiguration(): configuration.sipDomain:"+c.sipDomain);console.debug("PrivateJainSipClientConnector:checkConfiguration(): configuration.sipUserName:"+c.sipUserName);console.debug("PrivateJainSipClientConnector:checkConfiguration(): configuration.sipLogin:"+c.sipLogin);console.debug("PrivateJainSipClientConnector:checkConfiguration(): configuration.sipPassword: "+c.sipPassword);console.debug("PrivateJainSipClientConnector:checkConfiguration(): configuration.sipRegisterMode:"+c.sipRegisterMode);return a}catch(b){console.error("PrivateJainSipClientConnector:checkConfiguration(): catched exception:"+b);return false}};PrivateJainSipClientConnector.prototype.processConnected=function(){console.debug("PrivateJainSipClientConnector:processConnected()");try{if(this.openedFlag==false){if(this.configuration.sipRegisterMode==true){this.resetSipRegisterContext();this.sendNewSipRegisterRequest(this.SIP_SESSION_EXPIRATION_TIMER);this.sipRegisterState=this.SIP_REGISTERING_STATE;return}else{this.openedFlag=true;this.webRTCommClient.onPrivateClientConnectorOpenedEvent();return}}else{console.error("PrivateJainSipClientConnector:processConnected(): this.openedFlag==true !")}this.reset();this.webRTCommClient.onPrivateClientConnectorOpenErrorEvent()}catch(a){this.reset();this.webRTCommClient.onPrivateClientConnectorOpenErrorEvent();console.error("PrivateJainSipClientConnector:processConnected(): catched exception:"+a)}};PrivateJainSipClientConnector.prototype.sendNewSipRegisterRequest=function(m){console.debug("PrivateJainSipClientConnector:sendNewSipRegisterRequest()");var a=this.configuration.sipUserName+"@"+this.configuration.sipDomain;var k=this.jainSipHeaderFactory.createCSeqHeader(1,"REGISTER");var o=this.jainSipHeaderFactory.createCallIdHeader(new String(new Date().getTime()));var c=this.jainSipHeaderFactory.createExpiresHeader(m);var g=this.jainSipHeaderFactory.createMaxForwardsHeader(70);var d=this.jainSipAddressFactory.createSipURI_user_host(null,this.configuration.sipDomain);var j=this.jainSipHeaderFactory.createHeaders(PrivateJainSipClientConnector.prototype.SIP_ALLOW_HEADER);var b=this.jainSipAddressFactory.createSipURI_user_host(null,a);var h=this.jainSipAddressFactory.createAddress_name_uri(null,b);var e=new Date();var n=e.getTime();var i=this.jainSipHeaderFactory.createFromHeader(h,n);var f=this.jainSipHeaderFactory.createToHeader(h,null);var l=this.jainSipListeningPoint.getViaHeader();this.jainSipRegisterRequest=this.jainSipMessageFactory.createRequest(d,"REGISTER",o,k,i,f,l,g);this.jainSipMessageFactory.addHeader(this.jainSipRegisterRequest,c);this.jainSipMessageFactory.addHeader(this.jainSipRegisterRequest,j);this.jainSipMessageFactory.addHeader(this.jainSipRegisterRequest,this.jainSipContactHeader);this.jainSipRegisterTransaction=this.jainSipProvider.getNewClientTransaction(this.jainSipRegisterRequest);this.jainSipRegisterDialog=this.jainSipRegisterTransaction.getDialog();this.jainSipRegisterRequest.setTransaction(this.jainSipRegisterTransaction);this.jainSipRegisterTransaction.sendRequest()};PrivateJainSipClientConnector.prototype.sendAuthenticatedSipRegisterRequest=function(d){console.debug("PrivateJainSipClientConnector:sendAuthenticatedSipRegisterRequest()");this.jainSipRegisterRequest.removeHeader("Authorization");var a=new SIPRequest();a.setMethod(this.jainSipRegisterRequest.getMethod());a.setRequestURI(this.jainSipRegisterRequest.getRequestURI());var c=this.jainSipRegisterRequest.getHeaders();for(var e=0;e<c.length;e++){a.addHeader(c[e])}var b=new Number(this.jainSipRegisterRequest.getCSeq().getSeqNumber());a.getCSeq().setSeqNumber(b+1);a.setCallId(this.jainSipRegisterRequest.getCallId());a.setVia(this.jainSipListeningPoint.getViaHeader());a.setFrom(this.jainSipRegisterRequest.getFrom());a.setTo(this.jainSipRegisterRequest.getTo());a.setMaxForwards(this.jainSipRegisterRequest.getMaxForwards());this.jainSipRegisterRequest=a;this.jainSipMessageFactory.addHeader(this.jainSipRegisterRequest,d);this.jainSipRegisterTransaction=this.jainSipProvider.getNewClientTransaction(this.jainSipRegisterRequest);this.jainSipRegisterRequest.setTransaction(this.jainSipRegisterTransaction);this.jainSipRegisterTransaction.sendRequest()};PrivateJainSipClientConnector.prototype.processDisconnected=function(){console.debug("PrivateJainSipClientConnector:processDisconnected(): SIP connectivity has been lost");try{this.reset();this.webRTCommClient.onPrivateClientConnectorClosedEvent()}catch(a){console.error("PrivateJainSipClientConnector:processDisconnected(): catched exception:"+a)}};PrivateJainSipClientConnector.prototype.processConnectionError=function(a){console.warn("PrivateJainSipClientConnector:processConnectionError(): SIP connection has failed, error:"+a);try{this.reset();this.webRTCommClient.onPrivateClientConnectorOpenErrorEvent()}catch(b){console.error("PrivateJainSipClientConnector:processConnectionError(): catched exception:"+b)}};PrivateJainSipClientConnector.prototype.processRequest=function(a){console.debug("PrivateJainSipClientConnector:processRequest()");try{var e=a.getRequest();var d=e.getMethod();if(d=="OPTIONS"){this.processSipOptionRequest(a)}else{var b=e.getCallId().getCallId();var f=this.findCallConnector(b);if(f){f.onJainSipClientConnectorSipRequestEvent(a)}else{if(d=="INVITE"){var g=new WebRTCommCall(this.webRTCommClient);g.incomingCallFlag=true;g.connector=this.createPrivateCallConnector(g,b);g.id=g.connector.getId();g.connector.sipCallState=PrivateJainSipCallConnector.prototype.SIP_INVITED_INITIAL_STATE;g.connector.onJainSipClientConnectorSipRequestEvent(a)}else{console.warn("PrivateJainSipClientConnector:processRequest(): SIP request ignored")}}}}catch(c){console.error("PrivateJainSipClientConnector:processRequest(): catched exception:"+c)}};PrivateJainSipClientConnector.prototype.processResponse=function(b){console.debug("PrivateJainSipClientConnector:processResponse()");try{var d=b.getResponse();if(d.getCSeq().getMethod()=="REGISTER"){this.processSipRegisterResponse(b)}else{var c=this.findCallConnector(d.getCallId().getCallId());if(c){c.onJainSipClientConnectorSipResponseEvent(b)}else{console.warn("PrivateJainSipClientConnector:processResponse(): PrivateJainSipCallConnector not found, SIP response ignored")}}}catch(a){console.error("PrivateJainSipClientConnector:processResponse(): catched exception:"+a)}};PrivateJainSipClientConnector.prototype.processTransactionTerminated=function(){console.debug("PrivateJainSipClientConnector:processTransactionTerminated()")};PrivateJainSipClientConnector.prototype.processDialogTerminated=function(){console.debug("PrivateJainSipClientConnector:processDialogTerminated()")};PrivateJainSipClientConnector.prototype.processIOException=function(a){console.error("PrivateJainSipClientConnector:processIOException(): exceptionEvent="+a.message)};PrivateJainSipClientConnector.prototype.processTimeout=function(a){console.debug("PrivateJainSipClientConnector:processTimeout():timeoutEvent="+a);try{var d=a.getClientTransaction();var b=d.getDialog().getCallId().getCallId();var e=this.findCallConnector(b,false);if(e){e.onJainSipClientConnectorSipTimeoutEvent(a)}else{if(this.jainSipRegisterRequest.getCallId().getCallId()==b){console.error("PrivateJainSipClientConnector:processTimeout(): SIP registration failed, request timeout, no response from SIP server");this.reset();this.webRTCommClient.onPrivateClientConnectorOpenErrorEvent("Request Timeout")}else{console.warn("PrivateJainSipClientConnector:processTimeout(): no dialog found, SIP timeout ignored")}}}catch(c){console.error("PrivateJainSipClientConnector:processTimeout(): catched exception:"+c)}};PrivateJainSipClientConnector.prototype.onSipRegisterTimeout=function(){console.debug("PrivateJainSipClientConnector:onSipRegisterTimeout()");try{if(this.sipRegisterState==this.SIP_REGISTERED_STATE){this.sipRegisterRefreshTimer=undefined;this.sipRegisterState=this.SIP_REGISTER_REFRESHING_STATE;this.sendNewSipRegisterRequest(this.SIP_SESSION_EXPIRATION_TIMER)}else{console.warn("PrivateJainSipClientConnector:onSipRegisterTimeout(): SIP REGISTER refresh stopped")}}catch(a){console.error("PrivateJainSipClientConnector:onSipRegisterTimeout(): catched exception:"+a)}};PrivateJainSipClientConnector.prototype.processSipRegisterResponse=function(d){console.debug("PrivateJainSipClientConnector:processSipRegisterResponse(): this.sipRegisterState="+this.sipRegisterState);var e=d.getResponse();var b=parseInt(e.getStatusCode());if(this.sipRegisterState==this.SIP_UNREGISTERED_STATE){console.error("PrivateJainSipClientConnector:processSipRegisterResponse(): bad state, SIP response ignored")}else{if((this.sipRegisterState==this.SIP_REGISTERING_STATE)||(this.sipRegisterState==this.SIP_REGISTER_REFRESHING_STATE)){if(b<200){console.debug("PrivateJainSipClientConnector:processSipRegisterResponse(): 1XX response ignored")}else{if(b==401){if(this.configuration.sipPassword!=undefined&&this.configuration.sipLogin!=undefined){this.sipRegisterState=this.SIP_REGISTERING_401_STATE;var a=this.jainSipHeaderFactory.createAuthorizationHeader(e,this.jainSipRegisterRequest,this.configuration.sipPassword,this.configuration.sipLogin);this.sendAuthenticatedSipRegisterRequest(a)}else{console.error("PrivateJainSipClientConnector:processSipRegisterResponse(): SIP registration failed:"+e.getStatusCode()+"  "+e.getStatusLine());this.reset();this.webRTCommClient.onPrivateClientConnectorOpenErrorEvent()}}else{if(b==200){this.sipRegisterState=this.SIP_REGISTERED_STATE;if(this.openedFlag==false){this.openedFlag=true;this.webRTCommClient.onPrivateClientConnectorOpenedEvent()}if(this.sipUnregisterPendingFlag==true){this.sipUnregisterPendingFlag=false;this.sipRegisterState=this.SIP_UNREGISTERING_STATE;if(this.sipRegisterRefreshTimer){clearTimeout(this.sipRegisterRefreshTimer)}this.sendNewSipRegisterRequest(0)}else{var c=this;if(this.sipRegisterRefreshTimer){clearTimeout(this.sipRegisterRefreshTimer)}this.sipRegisterRefreshTimer=setTimeout(function(){c.onSipRegisterTimeout()},40000)}}else{console.error("PrivateJainSipClientConnector:processSipRegisterResponse(): SIP registration failed:"+e.getStatusCode()+"  "+e.getStatusLine());this.reset();this.webRTCommClient.onPrivateClientConnectorOpenErrorEvent()}}}}else{if(this.sipRegisterState==this.SIP_REGISTERING_401_STATE){if(b<200){}else{if(b==200){this.sipRegisterState=this.SIP_REGISTERED_STATE;if(this.openedFlag==false){console.debug("PrivateJainSipClientConnector:processSipRegisterResponse(): this.openedFlag=true");this.openedFlag=true;this.webRTCommClient.onPrivateClientConnectorOpenedEvent()}if(this.sipUnregisterPendingFlag==true){this.sipUnregisterPendingFlag=false;this.sipRegisterState=this.SIP_UNREGISTERING_STATE;if(this.sipRegisterRefreshTimer){clearTimeout(this.sipRegisterRefreshTimer)}this.sendNewSipRegisterRequest(0)}else{var c=this;if(this.sipRegisterRefreshTimer){clearTimeout(this.sipRegisterRefreshTimer)}this.sipRegisterRefreshTimer=setTimeout(function(){c.onSipRegisterTimeout()},40000)}}else{console.error("PrivateJainSipClientConnector:processSipRegisterResponse(): SIP registration failed:"+e.getStatusCode()+"  "+e.getStatusLine());this.reset();this.webRTCommClient.onPrivateClientConnectorOpenErrorEvent()}}}else{if(this.sipRegisterState==this.SIP_REGISTERED_STATE){console.error("PrivateJainSipClientConnector:processSipRegisterResponse(): bad state, SIP response ignored")}else{if(this.sipRegisterState==this.SIP_UNREGISTERING_STATE){if(b<200){}else{if(b==401){this.sipRegisterState=this.SIP_UNREGISTERING_401_STATE;a=this.jainSipHeaderFactory.createAuthorizationHeader(e,this.jainSipRegisterRequest,this.configuration.sipPassword,this.configuration.sipLogin);this.sendAuthenticatedSipRegisterRequest(a)}else{if(b==200){this.reset();this.webRTCommClient.onPrivateClientConnectorClosedEvent()}else{console.error("PrivateJainSipClientConnector:processSipRegisterResponse(): SIP unregistration failed:"+e.getStatusCode()+"  "+e.getStatusLine());this.reset();this.webRTCommClient.onPrivateClientConnectorClosedEvent()}}}}else{if(this.sipRegisterState==this.SIP_UNREGISTERING_401_STATE){if(b<200){}else{if(b==200){this.reset();this.webRTCommClient.onPrivateClientConnectorClosedEvent()}else{console.error("PrivateJainSipClientConnector:processSipRegisterResponse(): SIP unregistration failed:"+e.getStatusCode()+"  "+e.getStatusLine());this.reset();this.webRTCommClient.onPrivateClientConnectorClosedEvent()}}}else{if(this.sipRegisterState==this.SIP_UNREGISTERED_STATE){console.error("PrivateJainSipClientConnector:processSipRegisterResponse(): bad state, SIP response ignored")}else{console.error("PrivateJainSipClientConnector:processSipRegisterResponse(): bad state, SIP response ignored")}}}}}}}};PrivateJainSipClientConnector.prototype.processSipOptionRequest=function(a){console.debug("PrivateJainSipClientConnector:processSipOptionRequest()");var b=a.getRequest();var c=b.createResponse(200,"OK");c.addHeader(this.jainSipContactHeader);c.removeHeader("P-Asserted-Identity");c.removeHeader("P-Charging-Vector");c.removeHeader("P-Charging-Function-Addresses");c.removeHeader("P-Called-Party-ID");a.getServerTransaction().sendResponse(c)};WebRTCommCall=function(a){if(a instanceof WebRTCommClient){console.debug("WebRTCommCall:WebRTCommCall()");this.id=undefined;this.webRTCommClient=a;this.calleePhoneNumber=undefined;this.callerPhoneNumber=undefined;this.callerDisplayName=undefined;this.incomingCallFlag=false;this.configuration=undefined;this.connector=undefined;this.peerConnection=undefined;this.peerConnectionState=undefined;this.remoteBundledAudioVideoMediaStream=undefined;this.remoteAudioMediaStream=undefined;this.remoteVideoMediaStream=undefined;this.remoteSdpOffer=undefined;this.messageChannel=undefined}else{throw"WebRTCommCall:WebRTCommCall(): bad arguments"}};WebRTCommCall.prototype.codecNames={0:"PCMU",8:"PCMA"};WebRTCommCall.prototype.isOpened=function(){if(this.connector){return this.connector.isOpened()}else{return false}};WebRTCommCall.prototype.isIncoming=function(){if(this.isOpened()){return this.incomingCallFlag}else{console.error("WebRTCommCall:isIncoming(): bad state, unauthorized action");throw"WebRTCommCall:isIncoming(): bad state, unauthorized action"}};WebRTCommCall.prototype.getId=function(){return this.id};WebRTCommCall.prototype.getCallerPhoneNumber=function(){return this.callerPhoneNumber};WebRTCommCall.prototype.getCallerDisplayName=function(){return this.callerDisplayName};WebRTCommCall.prototype.getConfiguration=function(){return this.configuration};WebRTCommCall.prototype.getCalleePhoneNumber=function(){return this.calleePhoneNumber};WebRTCommCall.prototype.getRemoteBundledAudioVideoMediaStream=function(){return this.remoteBundledAudioVideoMediaStream};WebRTCommCall.prototype.getRemoteAudioMediaStream=function(){return this.remoteAudioMediaStream};WebRTCommCall.prototype.getRemoteVideoMediaStream=function(){return this.remoteVideoMediaStream};WebRTCommCall.prototype.open=function(d,g){console.debug("WebRTCommCall:open():calleePhoneNumber="+d);console.debug("WebRTCommCall:open():configuration="+JSON.stringify(g));if(typeof(g)=="object"){if(this.webRTCommClient.isOpened()){if(this.checkConfiguration(g)){if(this.isOpened()==false){try{var c=this;this.calleePhoneNumber=d;this.configuration=g;this.connector.open(g);this.createRTCPeerConnection();this.peerConnection.addStream(this.configuration.localMediaStream);if(this.configuration.messageMediaFlag){if(this.peerConnection.createDataChannel){try{this.messageChannel=this.peerConnection.createDataChannel("mymessageChannel",{reliable:false});console.debug("WebRTCommCall:onRtcPeerConnectionMessageChannelOnMessageEvent(): this.messageChannel.label="+this.messageChannel.label);console.debug("WebRTCommCall:onRtcPeerConnectionMessageChannelOnMessageEvent(): this.messageChannel.reliable="+this.messageChannel.reliable);console.debug("WebRTCommCall:onRtcPeerConnectionMessageChannelOnMessageEvent(): this.messageChannel.binaryType="+this.messageChannel.binaryType);this.messageChannel.onopen=function(e){c.onRtcPeerConnectionMessageChannelOnOpenEvent(e)};this.messageChannel.onclose=function(e){c.onRtcPeerConnectionMessageChannelOnClose(e)};this.messageChannel.onerror=function(e){c.onRtcPeerConnectionMessageChannelOnErrorEvent(e)};this.messageChannel.onmessage=function(e){c.onRtcPeerConnectionMessageChannelOnMessageEvent(e)}}catch(b){alert("DataChannel not supported")}}}if(window.webkitRTCPeerConnection){var a={mandatory:{OfferToReceiveAudio:this.configuration.audioMediaFlag,OfferToReceiveVideo:this.configuration.videoMediaFlag,},optional:[]};console.debug("WebRTCommCall:open():sdpContraints="+JSON.stringify(a));this.peerConnection.createOffer(function(e){c.onRtcPeerConnectionCreateOfferSuccessEvent(e)},function(e){c.onRtcPeerConnectionCreateOfferErrorEvent(e)},a)}else{if(window.mozRTCPeerConnection){var a={mandatory:{OfferToReceiveAudio:this.configuration.audioMediaFlag,OfferToReceiveVideo:this.configuration.videoMediaFlag,MozDontOfferDataChannel:!this.configuration.messageMediaFlag},optional:[]};console.debug("WebRTCommCall:open():sdpContraints="+JSON.stringify(a));this.peerConnection.createOffer(function(e){c.onRtcPeerConnectionCreateOfferSuccessEvent(e)},function(e){c.onRtcPeerConnectionCreateOfferErrorEvent(e)},a)}}console.debug("WebRTCommCall:open():sdpContraints="+JSON.stringify(a))}catch(b){console.error("WebRTCommCall:open(): catched exception:"+b);setTimeout(function(){try{c.webRTCommClient.eventListener.onWebRTCommCallOpenErrorEvent(c,e)}catch(e){console.error("WebRTCommCall:onPrivateCallConnectorCallOpenErrorEvent(): catched exception in listener:"+e)}},1);try{this.close()}catch(f){}throw b}}else{console.error("WebRTCommCall:open(): bad state, unauthorized action");throw"WebRTCommCall:open(): bad state, unauthorized action"}}else{console.error("WebRTCommCall:open(): bad configuration");throw"WebRTCommCall:open(): bad configuration"}}else{console.error("WebRTCommCall:open(): bad state, unauthorized action");throw"WebRTCommCall:open(): bad state, unauthorized action"}}else{console.error("WebRTCommCall:open(): bad argument, check API documentation");throw"WebRTCommCall:open(): bad argument, check API documentation"}};WebRTCommCall.prototype.close=function(){console.debug("WebRTCommCall:close()");if(this.webRTCommClient.isOpened()){try{if(this.connector){this.connector.close()}if(this.peerConnection&&this.peerConnection.signalingState!="closed"){if(this.messageChannel){this.messageChannel.close()}this.peerConnection.close();this.peerConnection=undefined;var b=this;setTimeout(function(){b.webRTCommClient.eventListener.onWebRTCommCallClosedEvent(b)},1)}}catch(a){console.error("WebRTCommCall:open(): catched exception:"+a)}}else{console.error("WebRTCommCall:close(): bad state, unauthorized action");throw"WebRTCommCall:close(): bad state, unauthorized action"}};WebRTCommCall.prototype.accept=function(f){console.debug("WebRTCommCall:accept():configuration="+JSON.stringify(f));if(typeof(f)=="object"){if(this.webRTCommClient.isOpened()){if(this.checkConfiguration(f)){this.configuration=f;if(this.isOpened()==false){try{this.createRTCPeerConnection();this.peerConnection.addStream(this.configuration.localMediaStream);var d=undefined;if(window.webkitRTCPeerConnection){d=new RTCSessionDescription({type:"offer",sdp:this.remoteSdpOffer})}else{if(window.mozRTCPeerConnection){d=new mozRTCSessionDescription({type:"offer",sdp:this.remoteSdpOffer})}}var b=this;this.peerConnectionState="offer-received";this.peerConnection.setRemoteDescription(d,function(){b.onRtcPeerConnectionSetRemoteDescriptionSuccessEvent()},function(e){b.onRtcPeerConnectionSetRemoteDescriptionErrorEvent(e)})}catch(a){console.error("WebRTCommCall:accept(): catched exception:"+a);try{this.close()}catch(c){}throw a}}else{console.error("WebRTCommCall:accept(): bad state, unauthorized action");throw"WebRTCommCall:accept(): bad state, unauthorized action"}}else{console.error("WebRTCommCall:accept(): bad configuration");throw"WebRTCommCall:accept(): bad configuration"}}else{console.error("WebRTCommCall:accept(): bad state, unauthorized action");throw"WebRTCommCall:accept(): bad state, unauthorized action"}}else{console.error("WebRTCommCall:accept(): bad argument, check API documentation");throw"WebRTCommCall:accept(): bad argument, check API documentation"}};WebRTCommCall.prototype.reject=function(){console.debug("WebRTCommCall:reject()");if(this.webRTCommClient.isOpened()){try{this.connector.reject()}catch(a){console.error("WebRTCommCall:reject(): catched exception:"+a);try{this.close()}catch(b){}throw a}}else{console.error("WebRTCommCall:reject(): bad state, unauthorized action");throw"WebRTCommCall:reject(): bad state, unauthorized action"}};WebRTCommCall.prototype.sendMessage=function(b){console.debug("WebRTCommCall:sendMessage()");if(this.webRTCommClient.isOpened()){if(this.isOpened()){if(this.messageChannel&&this.messageChannel.readyState=="open"){try{this.messageChannel.send(b)}catch(a){console.error("WebRTCommCall:sendMessage(): catched exception:"+a);throw"WebRTCommCall:sendMessage(): catched exception:"+a}}else{console.error("WebRTCommCall:sendMessage(): bad state, unauthorized action");throw"WebRTCommCall:sendMessage(): bad state, unauthorized action, messageChannel not opened"}}else{console.error("WebRTCommCall:sendMessage(): bad state, unauthorized action");throw"WebRTCommCall:sendMessage(): bad state, unauthorized action"}}else{console.error("WebRTCommCall:sendMessage(): bad state, unauthorized action");throw"WebRTCommCall:sendMessage(): bad state, unauthorized action"}};WebRTCommCall.prototype.muteLocalAudioMediaStream=function(){console.debug("WebRTCommCall:muteLocalAudioMediaStream()");if(this.configuration.localMediaStream&&this.configuration.localMediaStream.signalingState==this.configuration.localMediaStream.LIVE){var b=undefined;if(this.configuration.localMediaStream.audioTracks){b=this.configuration.localMediaStream.audioTracks}else{if(this.configuration.localMediaStream.getAudioTracks){b=this.configuration.localMediaStream.getAudioTracks()}}if(b){for(var a=0;a<b.length;a++){b[a].enabled=false}}else{console.error("WebRTCommCall:muteLocalAudioMediaStream(): not implemented by navigator");throw"WebRTCommCall:muteLocalAudioMediaStream(): not implemented by navigator"}}else{console.error("WebRTCommCall:muteLocalAudioMediaStream(): bad state, unauthorized action");throw"WebRTCommCall:muteLocalAudioMediaStream(): bad state, unauthorized action"}};WebRTCommCall.prototype.unmuteLocalAudioMediaStream=function(){console.debug("WebRTCommCall:unmuteLocalAudioMediaStream()");if(this.configuration.localMediaStream&&this.configuration.localMediaStream.signalingState==this.configuration.localMediaStream.LIVE){var b=undefined;if(this.configuration.localMediaStream.audioTracks){b=this.configuration.localMediaStream.audioTracks}else{if(this.configuration.localMediaStream.getAudioTracks){b=this.configuration.localMediaStream.getAudioTracks()}}if(b){for(var a=0;a<b.length;a++){b[a].enabled=true}}else{console.error("WebRTCommCall:unmuteLocalAudioMediaStream(): not implemented by navigator");throw"WebRTCommCall:unmuteLocalAudioMediaStream(): not implemented by navigator"}}else{console.error("WebRTCommCall:unmuteLocalAudioMediaStream(): bad state, unauthorized action");throw"WebRTCommCall:unmuteLocalAudioMediaStream(): bad state, unauthorized action"}};WebRTCommCall.prototype.muteRemoteAudioMediaStream=function(){console.debug("WebRTCommCall:muteRemoteAudioMediaStream()");if(this.remoteBundledAudioVideoMediaStream&&this.remoteBundledAudioVideoMediaStream.signalingState==this.remoteBundledAudioVideoMediaStream.LIVE){var b=undefined;if(this.remoteBundledAudioVideoMediaStream.audioTracks){b=this.remoteBundledAudioVideoMediaStream.audioTracks}else{if(this.remoteBundledAudioVideoMediaStream.getAudioTracks){b=this.remoteBundledAudioVideoMediaStream.getAudioTracks()}}if(b){for(var a=0;a<b.length;a++){b[a].enabled=false}}else{console.error("WebRTCommCall:muteRemoteAudioMediaStream(): not implemented by navigator");throw"WebRTCommCall:muteRemoteAudioMediaStream(): not implemented by navigator"}}else{console.error("WebRTCommCall:muteRemoteAudioMediaStream(): bad state, unauthorized action");throw"WebRTCommCall:muteRemoteAudioMediaStream(): bad state, unauthorized action"}};WebRTCommCall.prototype.unmuteRemoteAudioMediaStream=function(){console.debug("WebRTCommCall:unmuteRemoteAudioMediaStream()");if(this.remoteBundledAudioVideoMediaStream&&this.remoteBundledAudioVideoMediaStream.signalingState==this.remoteBundledAudioVideoMediaStream.LIVE){var b=undefined;if(this.remoteBundledAudioVideoMediaStream.audioTracks){b=this.remoteBundledAudioVideoMediaStream.audioTracks}else{if(this.remoteBundledAudioVideoMediaStream.getAudioTracks){b=this.remoteBundledAudioVideoMediaStream.getAudioTracks()}}if(b){for(var a=0;a<b.length;a++){b[a].enabled=true}}else{console.error("WebRTCommCall:unmuteRemoteAudioMediaStream(): not implemented by navigator");throw"WebRTCommCall:unmuteRemoteAudioMediaStream(): not implemented by navigator"}}else{console.error("WebRTCommCall:unmuteRemoteAudioMediaStream(): bad state, unauthorized action");throw"WebRTCommCall:unmuteRemoteAudioMediaStream(): bad state, unauthorized action"}};WebRTCommCall.prototype.hideLocalVideoMediaStream=function(){console.debug("WebRTCommCall:hideLocalVideoMediaStream()");if(this.configuration.localMediaStream&&this.configuration.localMediaStream.signalingState==this.configuration.localMediaStream.LIVE){var b=undefined;if(this.configuration.localMediaStream.videoTracks){b=this.configuration.localMediaStream.videoTracks}else{if(this.configuration.localMediaStream.getVideoTracks){b=this.configuration.localMediaStream.getVideoTracks()}}if(b){b.enabled=!b.enabled;for(var a=0;a<b.length;a++){b[a].enabled=false}}else{console.error("WebRTCommCall:hideLocalVideoMediaStream(): not implemented by navigator");throw"WebRTCommCall:hideLocalVideoMediaStream(): not implemented by navigator"}}else{console.error("WebRTCommCall:hideLocalVideoMediaStream(): bad state, unauthorized action");throw"WebRTCommCall:hideLocalVideoMediaStream(): bad state, unauthorized action"}};WebRTCommCall.prototype.showLocalVideoMediaStream=function(){console.debug("WebRTCommCall:showLocalVideoMediaStream()");if(this.configuration.localMediaStream&&this.configuration.localMediaStream.signalingState==this.configuration.localMediaStream.LIVE){var b=undefined;if(this.configuration.localMediaStream.videoTracks){b=this.configuration.localMediaStream.videoTracks}else{if(this.configuration.localMediaStream.getVideoTracks){b=this.configuration.localMediaStream.getVideoTracks()}}if(b){b.enabled=!b.enabled;for(var a=0;a<b.length;a++){b[a].enabled=true}}else{console.error("WebRTCommCall:showLocalVideoMediaStream(): not implemented by navigator");throw"WebRTCommCall:showLocalVideoMediaStream(): not implemented by navigator"}}else{console.error("WebRTCommCall:showLocalVideoMediaStream(): bad state, unauthorized action");throw"WebRTCommCall:showLocalVideoMediaStream(): bad state, unauthorized action"}};WebRTCommCall.prototype.hideRemoteVideoMediaStream=function(){console.debug("WebRTCommCall:hideRemoteVideoMediaStream()");if(this.remoteBundledAudioVideoMediaStream&&this.remoteBundledAudioVideoMediaStream.signalingState==this.remoteBundledAudioVideoMediaStream.LIVE){var b=undefined;if(this.remoteBundledAudioVideoMediaStream.videoTracks){b=this.remoteBundledAudioVideoMediaStream.videoTracks}else{if(this.remoteBundledAudioVideoMediaStream.getVideoTracks){b=this.remoteBundledAudioVideoMediaStream.getVideoTracks()}}if(b){b.enabled=!b.enabled;for(var a=0;a<b.length;a++){b[a].enabled=false}}else{console.error("WebRTCommCall:hideRemoteVideoMediaStream(): not implemented by navigator");throw"WebRTCommCall:hideRemoteVideoMediaStream(): not implemented by navigator"}}else{console.error("WebRTCommCall:hideRemoteVideoMediaStream(): bad state, unauthorized action");throw"WebRTCommCall:hideRemoteVideoMediaStream(): bad state, unauthorized action"}};WebRTCommCall.prototype.showRemoteVideoMediaStream=function(){console.debug("WebRTCommCall:showRemoteVideoMediaStream()");if(this.remoteBundledAudioVideoMediaStream&&this.remoteBundledAudioVideoMediaStream.signalingState==this.remoteBundledAudioVideoMediaStream.LIVE){var b=undefined;if(this.remoteBundledAudioVideoMediaStream.videoTracks){b=this.remoteBundledAudioVideoMediaStream.videoTracks}else{if(this.remoteBundledAudioVideoMediaStream.getVideoTracks){b=this.remoteBundledAudioVideoMediaStream.getVideoTracks()}}if(b){b.enabled=!b.enabled;for(var a=0;a<b.length;a++){b[a].enabled=true}}else{console.error("WebRTCommCall:showRemoteVideoMediaStream(): not implemented by navigator");throw"WebRTCommCall:showRemoteVideoMediaStream(): not implemented by navigator"}}else{console.error("WebRTCommCall:showRemoteVideoMediaStream(): bad state, unauthorized action");throw"WebRTCommCall:showRemoteVideoMediaStream(): bad state, unauthorized action"}};WebRTCommCall.prototype.checkConfiguration=function(b){console.debug("WebRTCommCall:checkConfiguration()");var a=true;if(b.localMediaStream==undefined){a=false;console.error("WebRTCommCall:checkConfiguration(): missing localMediaStream")}if(b.audioMediaFlag==undefined||(typeof(b.audioMediaFlag)!="boolean")){a=false;console.error("WebRTCommCall:checkConfiguration(): missing audio media flag")}if(b.videoMediaFlag==undefined||(typeof(b.videoMediaFlag)!="boolean")){a=false;console.error("WebRTCommCall:checkConfiguration(): missing video media flag")}if(b.messageMediaFlag==undefined||(typeof(b.messageMediaFlag)!="boolean")){a=false;console.error("WebRTCommCall:checkConfiguration(): missing message media flag")}return a};WebRTCommCall.prototype.createRTCPeerConnection=function(){console.debug("WebRTCommCall:createPeerConnection()");var b={iceServers:[]};this.peerConnectionState="new";var c=this;if(this.webRTCommClient.configuration.RTCPeerConnection.stunServer){b.iceServers.push({url:"stun:"+this.webRTCommClient.configuration.RTCPeerConnection.stunServer})}if(this.webRTCommClient.configuration.RTCPeerConnection.turnServer&&this.webRTCommClient.configuration.RTCPeerConnection.turnLogin&&this.webRTCommClient.configuration.RTCPeerConnection.turnPassword){b.iceServers.push({url:"turn:"+this.webRTCommClient.configuration.RTCPeerConnection.turnLogin+"@"+this.webRTCommClient.configuration.RTCPeerConnection.turnServer,credential:this.webRTCommClient.configuration.RTCPeerConnection.turnPassword})}console.debug("WebRTCommCall:createPeerConnection():rtcPeerConnectionConfiguration="+JSON.stringify(b));console.debug("WebRTCommCall:createPeerConnection():peerConnectionContraints="+JSON.stringify(a));if(window.webkitRTCPeerConnection){var d="all";if(this.webRTCommClient.configuration.RTCPeerConnection.forceTurnMediaRelay){d="relay"}var a={mandatory:{IceTransports:d},optional:[{RtpDataChannels:true},{DtlsSrtpKeyAgreement:this.webRTCommClient.configuration.RTCPeerConnection.dtlsSrtpKeyAgreement}]};this.peerConnection=new window.webkitRTCPeerConnection(b,a)}else{if(window.mozRTCPeerConnection){this.peerConnection=new window.mozRTCPeerConnection(b,a)}}this.peerConnection.onaddstream=function(e){c.onRtcPeerConnectionOnAddStreamEvent(e)};this.peerConnection.onremovestream=function(e){c.onRtcPeerConnectionOnRemoveStreamEvent(e)};this.peerConnection.onstatechange=function(e){c.onRtcPeerConnectionStateChangeEvent(e)};if(window.webkitRTCPeerConnection){this.peerConnection.onsignalingstatechange=function(e){console.warn("RTCPeerConnection API update");c.onRtcPeerConnectionStateChangeEvent(e)}}this.peerConnection.onicecandidate=function(e){c.onRtcPeerConnectionIceCandidateEvent(e)};this.peerConnection.ongatheringchange=function(e){c.onRtcPeerConnectionGatheringChangeEvent(e)};this.peerConnection.onicechange=function(e){c.onRtcPeerConnectionIceChangeEvent(e)};if(window.webkitRTCPeerConnection){this.peerConnection.oniceconnectionchange=function(e){console.warn("RTCPeerConnection API update");c.onRtcPeerConnectionIceChangeEvent(e)}}this.peerConnection.onopen=function(e){c.onRtcPeerConnectionOnOpenEvent(e)};if(window.webkitRTCPeerConnection){this.peerConnection.onidentityresult=function(e){c.onRtcPeerConnectionIdentityResultEvent(e)}}this.peerConnection.ondatachannel=function(e){c.onRtcPeerConnectionOnMessageChannelEvent(e)};console.debug("WebRTCommCall:createPeerConnection(): this.peerConnection="+JSON.stringify(this.peerConnection))};WebRTCommCall.prototype.onPrivateCallConnectorRemoteSdpOfferEvent=function(a){console.debug("WebRTCommCall:onPrivateCallConnectorSdpOfferEvent()");this.remoteSdpOffer=a};WebRTCommCall.prototype.onPrivateCallConnectorRemoteSdpAnswerEvent=function(d){console.debug("WebRTCommCall:onPrivateCallConnectorRemoteSdpAnswerEvent()");try{var c=undefined;if(window.webkitRTCPeerConnection){c=new RTCSessionDescription({type:"answer",sdp:d})}else{if(window.mozRTCPeerConnection){c=new mozRTCSessionDescription({type:"answer",sdp:d})}}var b=this;this.peerConnectionState="answer-received";this.peerConnection.setRemoteDescription(c,function(){b.onRtcPeerConnectionSetRemoteDescriptionSuccessEvent()},function(e){b.onRtcPeerConnectionSetRemoteDescriptionErrorEvent(e)})}catch(a){console.error("WebRTCommCall:onPrivateCallConnectorRemoteSdpAnswerEvent(): catched exception:"+a);throw a}};WebRTCommCall.prototype.onPrivateCallConnectorCallOpenedEvent=function(){console.debug("WebRTCommCall:onPrivateCallConnectorCallOpenedEvent()");if(this.webRTCommClient.eventListener.onWebRTCommCallOpenEvent){var a=this;setTimeout(function(){try{a.webRTCommClient.eventListener.onWebRTCommCallOpenEvent(a)}catch(b){console.error("WebRTCommCall:onPrivateCallConnectorCallOpenedEvent(): catched exception in listener:"+b)}},1)}};WebRTCommCall.prototype.onPrivateCallConnectorCallInProgressEvent=function(){console.debug("WebRTCommCall:onPrivateCallConnectorCallOpenedEvent()");if(this.webRTCommClient.eventListener.onWebRTCommCallInProgressEvent){var a=this;setTimeout(function(){try{a.webRTCommClient.eventListener.onWebRTCommCallInProgressEvent(a)}catch(b){console.error("WebRTCommCall:onPrivateCallConnectorCallOpenedEvent(): catched exception in listener:"+b)}},1)}};WebRTCommCall.prototype.onPrivateCallConnectorCallOpenErrorEvent=function(a){console.debug("WebRTCommCall:onPrivateCallConnectorCallOpenErrorEvent():error="+a);if(this.webRTCommClient.eventListener.onWebRTCommCallOpenErrorEvent){var b=this;setTimeout(function(){try{b.webRTCommClient.eventListener.onWebRTCommCallOpenErrorEvent(b,a)}catch(c){console.error("WebRTCommCall:onPrivateCallConnectorCallOpenErrorEvent(): catched exception in listener:"+c)}},1)}};WebRTCommCall.prototype.onPrivateCallConnectorCallRingingEvent=function(b,a){console.debug("WebRTCommCall:onPrivateCallConnectorCallRingingEvent():callerPhoneNumber="+b);console.debug("WebRTCommCall:onPrivateCallConnectorCallRingingEvent():callerDisplayName="+a);this.callerPhoneNumber=b;this.callerDisplayName=a;if(this.webRTCommClient.eventListener.onWebRTCommCallRingingEvent){var c=this;setTimeout(function(){try{c.webRTCommClient.eventListener.onWebRTCommCallRingingEvent(c)}catch(d){console.error("WebRTCommCall:onPrivateCallConnectorCallOpenErrorEvent(): catched exception in listener:"+d)}},1)}};WebRTCommCall.prototype.onPrivateCallConnectorCallRingingBackEvent=function(){console.debug("WebRTCommCall:onPrivateCallConnectorCallRingingBackEvent()");if(this.webRTCommClient.eventListener.onWebRTCommCallRingingBackEvent){var a=this;setTimeout(function(){try{a.webRTCommClient.eventListener.onWebRTCommCallRingingBackEvent(a)}catch(b){console.error("WebRTCommCall:onPrivateCallConnectorCallOpenErrorEvent(): catched exception in listener:"+b)}},1)}};WebRTCommCall.prototype.onPrivateCallConnectorCallClosedEvent=function(){console.debug("WebRTCommCall:onPrivateCallConnectorCallClosedEvent()");this.connector=undefined;try{this.close()}catch(a){}};WebRTCommCall.prototype.onPrivateCallConnectorCallHangupEvent=function(){console.debug("WebRTCommCall:onPrivateCallConnectorCallHangupEvent()");if(this.webRTCommClient.eventListener.onWebRTCommCallHangupEvent){var a=this;setTimeout(function(){try{a.webRTCommClient.eventListener.onWebRTCommCallHangupEvent(a)}catch(b){console.error("WebRTCommCall:onPrivateCallConnectorCallHangupEvent(): catched exception in listener:"+b)}},1)}};WebRTCommCall.prototype.onRtcPeerConnectionErrorEvent=function(a){console.debug("WebRTCommCall:onRtcPeerConnectionErrorEvent(): error="+a);if(this.webRTCommClient.eventListener.onWebRTCommCallOpenErrorEvent){var c=this;setTimeout(function(){try{c.webRTCommClient.eventListener.onWebRTCommCallOpenErrorEvent(c,a)}catch(d){console.error("WebRTCommCall:onRtcPeerConnectionErrorEvent(): catched exception in listener:"+d)}},1)}try{this.close()}catch(b){}};WebRTCommCall.prototype.onRtcPeerConnectionOnAddStreamEvent=function(b){try{console.debug("WebRTCommCall:onRtcPeerConnectionOnAddStreamEvent(): event="+b);console.debug("WebRTCommCall:onRtcPeerConnectionOnAddStreamEvent(): event.type="+b.type);if(this.peerConnection){console.debug("WebRTCommCall:onRtcPeerConnectionOnAddStreamEvent(): this.peerConnection.signalingState="+this.peerConnection.signalingState);console.debug("WebRTCommCall:onRtcPeerConnectionOnAddStreamEvent(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRTCommCall:onRtcPeerConnectionOnAddStreamEvent(): this.peerConnection.iceConnectionState="+this.peerConnection.iceConnectionState);console.debug("WebRTCommCall:onRtcPeerConnectionOnAddStreamEvent(): this.peerConnectionState="+this.peerConnectionState);if(window.webkitRTCPeerConnection){this.remoteBundledAudioVideoMediaStream=b.stream}else{if(window.mozRTCPeerConnection){if(b.type=="audio"){this.remoteAudioMediaStream=b.stream}else{if(b.type=="video"){this.remoteVideoMediaStream=b.stream}else{console.error("WebRTCommCall:onRtcPeerConnectionOnAddStreamEvent(): unsupported event.type"+b)}}}}}else{console.warn("WebRTCommCall:onRtcPeerConnectionOnAddStreamEvent(): event ignored")}}catch(a){console.error("WebRTCommCall:onRtcPeerConnectionOnAddStreamEvent(): catched exception, exception:"+a);this.onRtcPeerConnectionErrorEvent()}};WebRTCommCall.prototype.onRtcPeerConnectionOnRemoveStreamEvent=function(b){try{console.debug("WebRTCommCall:onRtcPeerConnectionOnRemoveStreamEvent(): event="+b);if(this.peerConnection){console.debug("WebRTCommCall:onRtcPeerConnectionOnRemoveStreamEvent(): this.peerConnection.signalingState="+this.peerConnection.signalingState);console.debug("WebRTCommCall:onRtcPeerConnectionOnRemoveStreamEvent(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRTCommCall:onRtcPeerConnectionOnRemoveStreamEvent(): this.peerConnection.iceConnectionState="+this.peerConnection.iceConnectionState);console.debug("WebRTCommCall:onRtcPeerConnectionOnRemoveStreamEvent(): this.peerConnectionState="+this.peerConnectionState);this.remoteBundledAudioVideoMediaStream=undefined}else{console.warn("WebRTCommCall:onRtcPeerConnectionOnRemoveStreamEvent(): event ignored")}}catch(a){console.error("WebRTCommCall:onRtcPeerConnectionOnRemoveStreamEvent(): catched exception, exception:"+a);this.onRtcPeerConnectionErrorEvent()}};WebRTCommCall.prototype.onRtcPeerConnectionIceCandidateEvent=function(c){try{console.debug("WebRTCommCall:onRtcPeerConnectionIceCandidateEvent(): rtcIceCandidateEvent="+JSON.stringify(c.candidate));if(this.peerConnection){console.debug("WebRTCommCall:onRtcPeerConnectionIceCandidateEvent(): this.peerConnection.signalingState="+this.peerConnection.signalingState);console.debug("WebRTCommCall:onRtcPeerConnectionIceCandidateEvent(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRTCommCall:onRtcPeerConnectionIceCandidateEvent(): this.peerConnection.iceConnectionState="+this.peerConnection.iceConnectionState);console.debug("WebRTCommCall:onRtcPeerConnectionIceCandidateEvent(): this.peerConnectionState="+this.peerConnectionState);if(this.peerConnection.signalingState!="closed"){if(this.peerConnection.iceGatheringState=="complete"){if(window.webkitRTCPeerConnection){if(this.peerConnectionState=="preparing-offer"){this.connector.invite(this.peerConnection.localDescription.sdp);this.peerConnectionState="offer-sent"}else{if(this.peerConnectionState=="preparing-answer"){this.connector.accept(this.peerConnection.localDescription.sdp);this.peerConnectionState="established";if(this.webRTCommClient.eventListener.onWebRTCommCallOpenedEvent){var b=this;setTimeout(function(){try{b.webRTCommClient.eventListener.onWebRTCommCallOpenedEvent(b)}catch(d){console.error("WebRTCommCall:onRtcPeerConnectionIceCandidateEvent(): catched exception in listener:"+d)}},1)}}else{if(this.peerConnectionState=="established"){}else{console.error("WebRTCommCall:onRtcPeerConnectionIceCandidateEvent(): RTCPeerConnection bad state!")}}}}}}else{console.error("WebRTCommCall:onRtcPeerConnectionIceCandidateEvent(): RTCPeerConnection closed!")}}else{console.warn("WebRTCommCall:onRtcPeerConnectionIceCandidateEvent(): event ignored")}}catch(a){console.error("WebRTCommCall:onRtcPeerConnectionIceCandidateEvent(): catched exception, exception:"+a);this.onRtcPeerConnectionErrorEvent(a)}};WebRTCommCall.prototype.onRtcPeerConnectionCreateOfferSuccessEvent=function(f){try{console.debug("WebRTCommCall:onRtcPeerConnectionCreateOfferSuccessEvent(): sdpOffer="+JSON.stringify(f));if(this.peerConnection){console.debug("WebRTCommCall:onRtcPeerConnectionCreateOfferSuccessEvent(): this.peerConnection.signalingState="+this.peerConnection.signalingState);console.debug("WebRTCommCall:onRtcPeerConnectionCreateOfferSuccessEvent(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRTCommCall:onRtcPeerConnectionCreateOfferSuccessEvent(): this.peerConnection.iceConnectionState="+this.peerConnection.iceConnectionState);console.debug("WebRTCommCall:onRtcPeerConnectionCreateOfferSuccessEvent(): this.peerConnectionState="+this.peerConnectionState);if(this.peerConnectionState=="new"){var d=this;this.peerConnectionState="preparing-offer";var b=f.sdp;var e=new SDPParser();var a=e.parse(b);if(this.configuration.videoMediaFlag==false){this.removeMediaDescription(a,"video");f.sdp=a}if(this.configuration.audioMediaFlag==false){this.removeMediaDescription(a,"audio");f.sdp=a}if(this.configuration.audioCodecsFilter||this.configuration.videoCodecsFilter){try{this.applyConfiguredCodecFilterOnSessionDescription(a,this.configuration.audioCodecsFilter);console.debug("WebRTCommCall:onRtcPeerConnectionCreateOfferSuccessEvent(): parsedSdpOffer="+a);f.sdp=a}catch(c){console.error("WebRTCommCall:onRtcPeerConnectionCreateOfferSuccessEvent(): configured codec filtering has failded, use inital RTCPeerConnection SDP offer")}}this.peerConnectionLocalDescription=f;this.peerConnection.setLocalDescription(f,function(){d.onRtcPeerConnectionSetLocalDescriptionSuccessEvent()},function(g){d.onRtcPeerConnectionSetLocalDescriptionErrorEvent(g)})}else{console.error("WebRTCommCall:onRtcPeerConnectionCreateOfferSuccessEvent(): RTCPeerConnection bad state!")}}else{console.warn("WebRTCommCall:onRtcPeerConnectionCreateOfferSuccessEvent(): event ignored")}}catch(c){console.error("WebRTCommCall:onRtcPeerConnectionCreateOfferSuccessEvent(): catched exception, exception:"+c);this.onRtcPeerConnectionErrorEvent()}};WebRTCommCall.prototype.onRtcPeerConnectionCreateOfferErrorEvent=function(a){try{console.error("WebRTCommCall:onRtcPeerConnectionCreateOfferErrorEvent():error="+JSON.stringify(a));if(this.peerConnection){console.debug("WebRTCommCall:onRtcPeerConnectionCreateOfferErrorEvent(): this.peerConnection.signalingState="+this.peerConnection.signalingState);console.debug("WebRTCommCall:onRtcPeerConnectionCreateOfferErrorEvent(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRTCommCall:onRtcPeerConnectionCreateOfferErrorEvent(): this.peerConnection.iceConnectionState="+this.peerConnection.iceConnectionState);console.debug("WebRTCommCall:onRtcPeerConnectionCreateOfferErrorEvent(): this.peerConnectionState="+this.peerConnectionState);throw"WebRTCommCall:onRtcPeerConnectionCreateOfferErrorEvent():error="+a}else{console.warn("WebRTCommCall:onRtcPeerConnectionCreateOfferErrorEvent(): event ignored")}}catch(b){console.error("WebRTCommCall:onRtcPeerConnectionCreateOfferErrorEvent(): catched exception, exception:"+b);this.onRtcPeerConnectionErrorEvent()}};WebRTCommCall.prototype.onRtcPeerConnectionSetLocalDescriptionSuccessEvent=function(){try{console.debug("WebRTCommCall:onRtcPeerConnectionSetLocalDescriptionSuccessEvent():"+JSON.stringify(this.peerConnection));if(this.peerConnection){console.debug("WebRTCommCall:onRtcPeerConnectionSetLocalDescriptionSuccessEvent(): this.peerConnection.signalingState="+this.peerConnection.signalingState);console.debug("WebRTCommCall:onRtcPeerConnectionSetLocalDescriptionSuccessEvent(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRTCommCall:onRtcPeerConnectionSetLocalDescriptionSuccessEvent(): this.peerConnection.iceConnectionState="+this.peerConnection.iceConnectionState);console.debug("WebRTCommCall:onRtcPeerConnectionSetLocalDescriptionSuccessEvent(): this.peerConnectionState="+this.peerConnectionState);if(window.mozRTCPeerConnection){var a=undefined;if(this.peerConnection.localDescription){a=this.peerConnection.localDescription.sdp}else{a=this.peerConnectionLocalDescription.sdp}if(this.peerConnectionState=="preparing-offer"){this.connector.invite(this.peerConnectionLocalDescription.sdp);this.peerConnectionState="offer-sent"}else{if(this.peerConnectionState=="preparing-answer"){this.connector.accept(this.peerConnectionLocalDescription.sdp);this.peerConnectionState="established";if(this.webRTCommClient.eventListener.onWebRTCommCallOpenedEvent){var c=this;setTimeout(function(){try{c.webRTCommClient.eventListener.onWebRTCommCallOpenedEvent(c)}catch(d){console.error("WebRTCommCall:onRtcPeerConnectionSetLocalDescriptionSuccessEvent(): catched exception in listener:"+d)}},1)}}else{if(this.peerConnectionState=="established"){}else{console.error("WebRTCommCall:onRtcPeerConnectionSetLocalDescriptionSuccessEvent(): RTCPeerConnection bad state!")}}}}}else{console.warn("WebRTCommCall:onRtcPeerConnectionSetLocalDescriptionSuccessEvent(): event ignored")}}catch(b){console.error("WebRTCommCall:onRtcPeerConnectionSetLocalDescriptionSuccessEvent(): catched exception, exception:"+b);this.onRtcPeerConnectionErrorEvent()}};WebRTCommCall.prototype.onRtcPeerConnectionSetLocalDescriptionErrorEvent=function(a){try{console.error("WebRTCommCall:onRtcPeerConnectionSetLocalDescriptionErrorEvent():error="+JSON.stringify(a));if(this.peerConnection){console.debug("WebRTCommCall:onRtcPeerConnectionSetLocalDescriptionErrorEvent(): this.peerConnection.signalingState="+this.peerConnection.signalingState);console.debug("WebRTCommCall:onRtcPeerConnectionSetLocalDescriptionErrorEvent(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRTCommCall:onRtcPeerConnectionSetLocalDescriptionErrorEvent(): this.peerConnection.iceConnectionState="+this.peerConnection.iceConnectionState);console.debug("WebRTCommCall:onRtcPeerConnectionSetLocalDescriptionErrorEvent(): this.peerConnectionState="+this.peerConnectionState);throw"WebRTCommCall:onRtcPeerConnectionSetLocalDescriptionErrorEvent():error="+a}else{console.warn("WebRTCommCall:onRtcPeerConnectionSetLocalDescriptionErrorEvent(): event ignored")}}catch(b){console.error("WebRTCommCall:onRtcPeerConnectionSetLocalDescriptionErrorEvent(): catched exception, exception:"+b);this.onRtcPeerConnectionErrorEvent()}};WebRTCommCall.prototype.onRtcPeerConnectionCreateAnswerSuccessEvent=function(c){try{console.debug("WebRTCommCall:onRtcPeerConnectionCreateAnswerSuccessEvent():answer="+JSON.stringify(c));if(this.peerConnection){console.debug("WebRTCommCall:onRtcPeerConnectionCreateAnswerSuccessEvent(): this.peerConnection.signalingState="+this.peerConnection.signalingState);console.debug("WebRTCommCall:onRtcPeerConnectionCreateAnswerSuccessEvent(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRTCommCall:onRtcPeerConnectionCreateAnswerSuccessEvent(): this.peerConnection.iceConnectionState="+this.peerConnection.iceConnectionState);console.debug("WebRTCommCall:onRtcPeerConnectionCreateAnswerSuccessEvent(): this.peerConnectionState="+this.peerConnectionState);if(this.peerConnectionState=="offer-received"){var b=this;this.peerConnectionState="preparing-answer";this.peerConnectionLocalDescription=c;this.peerConnection.setLocalDescription(c,function(){b.onRtcPeerConnectionSetLocalDescriptionSuccessEvent()},function(d){b.onRtcPeerConnectionSetLocalDescriptionErrorEvent(d)})}else{console.error("WebRTCommCall:onRtcPeerConnectionCreateAnswerSuccessEvent(): RTCPeerConnection bad state!")}}else{console.warn("WebRTCommCall:onRtcPeerConnectionCreateAnswerSuccessEvent(): event ignored")}}catch(a){console.error("WebRTCommCall:onRtcPeerConnectionCreateAnswerSuccessEvent(): catched exception, exception:"+a);this.onRtcPeerConnectionErrorEvent()}};WebRTCommCall.prototype.onRtcPeerConnectionCreateAnswerErrorEvent=function(a){console.error("WebRTCommCall:onRtcPeerConnectionCreateAnswerErrorEvent():error="+JSON.stringify(a));try{if(this.peerConnection){console.debug("WebRTCommCall:onRtcPeerConnectionCreateAnswerErrorEvent(): this.peerConnection.signalingState="+this.peerConnection.signalingState);console.debug("WebRTCommCall:onRtcPeerConnectionCreateAnswerErrorEvent(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRTCommCall:onRtcPeerConnectionCreateAnswerErrorEvent(): this.peerConnection.iceConnectionState="+this.peerConnection.iceConnectionState);console.debug("WebRTCommCall:onRtcPeerConnectionCreateAnswerErrorEvent(): this.peerConnectionState="+this.peerConnectionState)}else{console.warn("WebRTCommCall:onRtcPeerConnectionCreateAnswerErrorEvent(): event ignored")}}catch(b){console.error("WebRTCommCall:onRtcPeerConnectionCreateAnswerErrorEvent(): catched exception, exception:"+b);this.onRtcPeerConnectionErrorEvent()}};WebRTCommCall.prototype.onRtcPeerConnectionSetRemoteDescriptionSuccessEvent=function(){try{console.debug("WebRTCommCall:onRtcPeerConnectionSetRemoteDescriptionSuccessEvent()");if(this.peerConnection){console.debug("WebRTCommCall:onRtcPeerConnectionSetRemoteDescriptionSuccessEvent(): this.peerConnection.signalingState="+this.peerConnection.signalingState);console.debug("WebRTCommCall:onRtcPeerConnectionSetRemoteDescriptionSuccessEvent(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRTCommCall:onRtcPeerConnectionSetRemoteDescriptionSuccessEvent(): this.peerConnection.iceConnectionState="+this.peerConnection.iceConnectionState);console.debug("WebRTCommCall:onRtcPeerConnectionSetRemoteDescriptionSuccessEvent(): this.peerConnectionState="+this.peerConnectionState);if(this.peerConnectionState=="answer-received"){this.peerConnectionState="established";if(this.webRTCommClient.eventListener.onWebRTCommCallOpenedEvent){var c=this;setTimeout(function(){try{c.webRTCommClient.eventListener.onWebRTCommCallOpenedEvent(c)}catch(d){console.error("WebRTCommCall:onRtcPeerConnectionSetRemoteDescriptionSuccessEvent(): catched exception in listener:"+d)}},1)}}else{if(this.peerConnectionState=="offer-received"){var c=this;if(window.webkitRTCPeerConnection){var b={mandatory:{OfferToReceiveAudio:this.configuration.audioMediaFlag,OfferToReceiveVideo:this.configuration.videoMediaFlag,},optional:[]};this.peerConnection.createAnswer(function(d){c.onRtcPeerConnectionCreateAnswerSuccessEvent(d)},function(d){c.onRtcPeerConnectionCreateAnswerErrorEvent(d)},b)}else{if(window.mozRTCPeerConnection){var b={mandatory:{OfferToReceiveAudio:this.configuration.audioMediaFlag,OfferToReceiveVideo:this.configuration.videoMediaFlag,MozDontOfferDataChannel:!this.configuration.messageMediaFlag},optional:[]};this.peerConnection.createAnswer(function(d){c.onRtcPeerConnectionCreateAnswerSuccessEvent(d)},function(d){c.onRtcPeerConnectionCreateAnswerErrorEvent(d)},b)}}}else{console.error("WebRTCommCall:onRtcPeerConnectionSetRemoteDescriptionSuccessEvent(): RTCPeerConnection bad state!")}}}else{console.warn("WebRTCommCall:onRtcPeerConnectionSetRemoteDescriptionSuccessEvent(): event ignored")}}catch(a){console.error("WebRTCommCall:onRtcPeerConnectionSetRemoteDescriptionSuccessEvent(): catched exception, exception:"+a);this.onRtcPeerConnectionErrorEvent()}};WebRTCommCall.prototype.onRtcPeerConnectionSetRemoteDescriptionErrorEvent=function(a){try{console.error("WebRTCommCall:onRtcPeerConnectionSetRemoteDescriptionErrorEvent():error="+JSON.stringify(a));if(this.peerConnection){console.debug("WebRTCommCall:onRtcPeerConnectionSetRemoteDescriptionErrorEvent(): this.peerConnection.signalingState="+this.peerConnection.signalingState);console.debug("WebRTCommCall:onRtcPeerConnectionSetRemoteDescriptionErrorEvent(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRTCommCall:onRtcPeerConnectionSetRemoteDescriptionErrorEvent(): this.peerConnection.iceConnectionState="+this.peerConnection.iceConnectionState);console.debug("WebRTCommCall:onRtcPeerConnectionSetRemoteDescriptionErrorEvent(): this.peerConnectionState="+this.peerConnectionState);throw"WebRTCommCall:onRtcPeerConnectionSetRemoteDescriptionErrorEvent():error="+a}else{console.warn("WebRTCommCall:onRtcPeerConnectionSetRemoteDescriptionErrorEvent(): event ignored")}}catch(b){this.onRtcPeerConnectionErrorEvent(a)}};WebRTCommCall.prototype.onRtcPeerConnectionOnOpenEvent=function(a){console.debug("WebRTCommCall:onRtcPeerConnectionOnOpenEvent(): event="+a);if(this.peerConnection){console.debug("WebRTCommCall:onRtcPeerConnectionOnOpenEvent(): this.peerConnection.signalingState="+this.peerConnection.signalingState);console.debug("WebRTCommCall:onRtcPeerConnectionOnOpenEvent(): this.peerConnection.signalingState="+this.peerConnection.signalingState);console.debug("WebRTCommCall:onRtcPeerConnectionOnOpenEvent(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRTCommCall:onRtcPeerConnectionOnOpenEvent(): this.peerConnection.iceConnectionState="+this.peerConnection.iceConnectionState);console.debug("WebRTCommCall:onRtcPeerConnectionOnOpenEvent(): this.peerConnectionState="+this.peerConnectionState)}else{console.warn("WebRTCommCall:onRtcPeerConnectionOnOpenEvent(): event ignored")}};WebRTCommCall.prototype.onRtcPeerConnectionStateChangeEvent=function(a){console.debug("WebRTCommCall:onRtcPeerConnectionStateChangeEvent(): event="+a);if(this.peerConnection){console.debug("WebRTCommCall:onRtcPeerConnectionStateChangeEvent(): this.peerConnection.signalingState="+this.peerConnection.signalingState);console.debug("WebRTCommCall:onRtcPeerConnectionStateChangeEvent(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRTCommCall:onRtcPeerConnectionStateChangeEvent(): this.peerConnection.iceConnectionState="+this.peerConnection.iceConnectionState);console.debug("WebRTCommCall:onRtcPeerConnectionStateChangeEvent(): this.peerConnectionState="+this.peerConnectionState);if(this.peerConnection&&this.peerConnection.signalingState=="closed"){this.peerConnection=null}}else{console.warn("WebRTCommCall:onRtcPeerConnectionStateChangeEvent(): event ignored")}};WebRTCommCall.prototype.onRtcPeerConnectionIceNegotiationNeededEvent=function(a){console.debug("WebRTCommCall:onRtcPeerConnectionIceNegotiationNeededEvent():event="+a);if(this.peerConnection){console.debug("WebRTCommCall:onRtcPeerConnectionIceNegotiationNeededEvent(): this.peerConnection.signalingState="+this.peerConnection.signalingState);console.debug("WebRTCommCall:onRtcPeerConnectionIceNegotiationNeededEvent(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRTCommCall:onRtcPeerConnectionIceNegotiationNeededEvent(): this.peerConnection.iceConnectionState="+this.peerConnection.iceConnectionState);console.debug("WebRTCommCall:onRtcPeerConnectionIceNegotiationNeededEvent(): this.peerConnectionState="+this.peerConnectionState)}else{console.warn("WebRTCommCall:onRtcPeerConnectionIceNegotiationNeededEvent(): event ignored")}};WebRTCommCall.prototype.onRtcPeerConnectionGatheringChangeEvent=function(b){console.debug("WebRTCommCall:onRtcPeerConnectionGatheringChangeEvent():event="+b);if(this.peerConnection){console.debug("WebRTCommCall:onRtcPeerConnectionGatheringChangeEvent(): this.peerConnection.signalingState="+this.peerConnection.signalingState);console.debug("WebRTCommCall:onRtcPeerConnectionGatheringChangeEvent(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRTCommCall:onRtcPeerConnectionGatheringChangeEvent(): this.peerConnection.iceConnectionState="+this.peerConnection.iceConnectionState);console.debug("WebRTCommCall:onRtcPeerConnectionGatheringChangeEvent(): this.peerConnectionState="+this.peerConnectionState);if(this.peerConnection.signalingState!="closed"){if(this.peerConnection.iceGatheringState=="complete"){if(window.webkitRTCPeerConnection){if(this.peerConnectionState=="preparing-offer"){this.connector.invite(this.peerConnection.localDescription.sdp);this.peerConnectionState="offer-sent"}else{if(this.peerConnectionState=="preparing-answer"){this.connector.accept(this.peerConnection.localDescription.sdp);this.peerConnectionState="established";if(this.webRTCommClient.eventListener.onWebRTCommCallOpenedEvent){var a=this;setTimeout(function(){try{a.webRTCommClient.eventListener.onWebRTCommCallOpenedEvent(a)}catch(c){console.error("WebRTCommCall:onRtcPeerConnectionGatheringChangeEvent(): catched exception in listener:"+c)}},1)}}else{if(this.peerConnectionState=="established"){}else{console.error("WebRTCommCall:onRtcPeerConnectionGatheringChangeEvent(): RTCPeerConnection bad state!")}}}}}}else{console.error("WebRTCommCall:onRtcPeerConnectionGatheringChangeEvent(): RTCPeerConnection closed!")}}else{console.warn("WebRTCommCall:onRtcPeerConnectionGatheringChangeEvent(): event ignored")}};WebRTCommCall.prototype.onRtcPeerConnectionIceChangeEvent=function(a){console.debug("WebRTCommCall:onRtcPeerConnectionIceChangeEvent():event="+a);if(this.peerConnection){console.debug("WebRTCommCall:onRtcPeerConnectionIceChangeEvent(): this.peerConnection.signalingState="+this.peerConnection.signalingState);console.debug("WebRTCommCall:onRtcPeerConnectionIceChangeEvent(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRTCommCall:onRtcPeerConnectionIceChangeEvent(): this.peerConnection.iceConnectionState="+this.peerConnection.iceConnectionState);console.debug("WebRTCommCall:onRtcPeerConnectionIceChangeEvent(): this.peerConnectionState="+this.peerConnectionState)}else{console.warn("WebRTCommCall:onRtcPeerConnectionIceChangeEvent(): event ignored")}};WebRTCommCall.prototype.onRtcPeerConnectionIdentityResultEvent=function(a){console.debug("WebRTCommCall:onRtcPeerConnectionIdentityResultEvent():event="+a);if(this.peerConnection){console.debug("WebRTCommCall:onRtcPeerConnectionIdentityResultEvent(): this.peerConnection.signalingState="+this.peerConnection.signalingState);console.debug("WebRTCommCall:onRtcPeerConnectionIdentityResultEvent(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRTCommCall:onRtcPeerConnectionIdentityResultEvent(): this.peerConnection.iceConnectionState="+this.peerConnection.iceConnectionState);console.debug("WebRTCommCall:onRtcPeerConnectionIdentityResultEvent(): this.peerConnectionState="+this.peerConnectionState)}else{console.warn("WebRTCommCall:onRtcPeerConnectionIdentityResultEvent(): event ignored")}};WebRTCommCall.prototype.onRtcPeerConnectionOnMessageChannelEvent=function(b){console.debug("WebRTCommCall:onRtcPeerConnectionOnMessageChannelEvent():event="+JSON.stringify(b));if(this.peerConnection){console.debug("WebRTCommCall:onRtcPeerConnectionOnMessageChannelEvent(): this.peerConnection.signalingState="+this.peerConnection.signalingState);console.debug("WebRTCommCall:onRtcPeerConnectionOnMessageChannelEvent(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRTCommCall:onRtcPeerConnectionOnMessageChannelEvent(): this.peerConnection.iceConnectionState="+this.peerConnection.iceConnectionState);console.debug("WebRTCommCall:onRtcPeerConnectionOnMessageChannelEvent(): this.peerConnectionState="+this.peerConnectionState);this.messageChannel=b.channel;console.debug("WebRTCommCall:onRtcPeerConnectionOnMessageChannelEvent(): this.messageChannel.label="+this.messageChannel.label);console.debug("WebRTCommCall:onRtcPeerConnectionOnMessageChannelEvent(): this.messageChannel.reliable="+this.messageChannel.reliable);console.debug("WebRTCommCall:onRtcPeerConnectionOnMessageChannelEvent(): this.messageChannel.binaryType="+this.messageChannel.binaryType);var a=this;this.messageChannel.onopen=function(c){a.onRtcPeerConnectionMessageChannelOnOpenEvent(c)};this.messageChannel.onclose=function(c){a.onRtcPeerConnectionMessageChannelOnClose(c)};this.messageChannel.onerror=function(c){a.onRtcPeerConnectionMessageChannelOnErrorEvent(c)};this.messageChannel.onmessage=function(c){a.onRtcPeerConnectionMessageChannelOnMessageEvent(c)}}else{console.warn("WebRTCommCall:onRtcPeerConnectionOnMessageChannelEvent(): event ignored")}};WebRTCommCall.prototype.onRtcPeerConnectionMessageChannelOnOpenEvent=function(a){console.debug("WebRTCommCall:onRtcPeerConnectionMessageChannelOnOpenEvent():event="+a);if(this.peerConnection){console.debug("WebRTCommCall:onRtcPeerConnectionMessageChannelOnOpenEvent(): this.peerConnection.signalingState="+this.peerConnection.signalingState);console.debug("WebRTCommCall:onRtcPeerConnectionMessageChannelOnOpenEvent(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRTCommCall:onRtcPeerConnectionMessageChannelOnOpenEvent(): this.peerConnection.iceConnectionState="+this.peerConnection.iceConnectionState);console.debug("WebRTCommCall:onRtcPeerConnectionMessageChannelOnOpenEvent(): this.peerConnectionState="+this.peerConnectionState);if(this.messageChannel){console.debug("WebRTCommCall:onRtcPeerConnectionMessageChannelOnOpenEvent(): this.messageChannel.readyState="+this.messageChannel.readyState);console.debug("WebRTCommCall:onRtcPeerConnectionMessageChannelOnOpenEvent(): this.messageChannel.binaryType="+this.messageChannel.bufferedAmmount)}}else{console.warn("WebRTCommCall:onRtcPeerConnectionMessageChannelOnOpenEvent(): event ignored")}};WebRTCommCall.prototype.onRtcPeerConnectionMessageChannelOnClose=function(a){console.debug("WebRTCommCall:onRtcPeerConnectionMessageChannelOnClose():event="+a);if(this.peerConnection){console.debug("WebRTCommCall:onRtcPeerConnectionMessageChannelOnClose(): this.peerConnection.signalingState="+this.peerConnection.signalingState);console.debug("WebRTCommCall:onRtcPeerConnectionMessageChannelOnClose(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRTCommCall:onRtcPeerConnectionMessageChannelOnClose(): this.peerConnection.iceConnectionState="+this.peerConnection.iceConnectionState);console.debug("WebRTCommCall:onRtcPeerConnectionMessageChannelOnClose(): this.peerConnectionState="+this.peerConnectionState);if(this.messageChannel){console.debug("WebRTCommCall:onRtcPeerConnectionMessageChannelOnClose(): this.messageChannel.readyState="+this.messageChannel.readyState);console.debug("WebRTCommCall:onRtcPeerConnectionMessageChannelOnClose(): this.messageChannel.binaryType="+this.messageChannel.bufferedAmmount)}}else{console.warn("WebRTCommCall:onRtcPeerConnectionMessageChannelOnClose(): event ignored")}};WebRTCommCall.prototype.onRtcPeerConnectionMessageChannelOnErrorEvent=function(a){console.debug("WebRTCommCall:onRtcPeerConnectionMessageChannelOnErrorEvent():event="+a);if(this.peerConnection){console.debug("WebRTCommCall:onRtcPeerConnectionMessageChannelOnErrorEvent(): this.peerConnection.signalingState="+this.peerConnection.signalingState);console.debug("WebRTCommCall:onRtcPeerConnectionMessageChannelOnErrorEvent(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRTCommCall:onRtcPeerConnectionMessageChannelOnErrorEvent(): this.peerConnection.iceConnectionState="+this.peerConnection.iceConnectionState);console.debug("WebRTCommCall:onRtcPeerConnectionMessageChannelOnErrorEvent(): this.peerConnectionState="+this.peerConnectionState);if(this.messageChannel){console.debug("WebRTCommCall:onRtcPeerConnectionMessageChannelOnErrorEvent(): this.messageChannel.readyState="+this.messageChannel.readyState);console.debug("WebRTCommCall:onRtcPeerConnectionMessageChannelOnErrorEvent(): this.messageChannel.binaryType="+this.messageChannel.bufferedAmmount)}}else{console.warn("WebRTCommCall:onRtcPeerConnectionMessageChannelOnErrorEvent(): event ignored")}};WebRTCommCall.prototype.onRtcPeerConnectionMessageChannelOnMessageEvent=function(b){console.debug("WebRTCommCall:onRtcPeerConnectionMessageChannelOnMessageEvent():event="+b);if(this.peerConnection){console.debug("WebRTCommCall:onRtcPeerConnectionMessageChannelOnMessageEvent(): this.peerConnection.signalingState="+this.peerConnection.signalingState);console.debug("WebRTCommCall:onRtcPeerConnectionMessageChannelOnMessageEvent(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRTCommCall:onRtcPeerConnectionMessageChannelOnMessageEvent(): this.peerConnection.iceConnectionState="+this.peerConnection.iceConnectionState);console.debug("WebRTCommCall:onRtcPeerConnectionMessageChannelOnMessageEvent(): this.peerConnectionState="+this.peerConnectionState);if(this.messageChannel){console.debug("WebRTCommCall:onRtcPeerConnectionMessageChannelOnMessageEvent(): this.messageChannel.readyState="+this.messageChannel.readyState);console.debug("WebRTCommCall:onRtcPeerConnectionMessageChannelOnMessageEvent(): this.messageChannel.binaryType="+this.messageChannel.bufferedAmmount);if(this.webRTCommClient.eventListener.onWebRTCommCallMessageEvent){var a=this;setTimeout(function(){try{a.webRTCommClient.eventListener.onWebRTCommCallMessageEvent(a,b.data)}catch(c){console.error("WebRTCommCall:onRtcPeerConnectionMessageChannelOnMessageEvent(): catched exception in listener:"+c)}},1)}}}else{console.warn("WebRTCommCall:onRtcPeerConnectionMessageChannelOnMessageEvent(): event ignored")}};WebRTCommCall.prototype.applyConfiguredCodecFilterOnSessionDescription=function(f){if(f instanceof SessionDescription){try{console.debug("WebRTCommCall:applyConfiguredCodecFilterOnSessionDescription(): sessionDescription="+f);var g=f.getMediaDescriptions(false);for(var e=0;e<g.length;e++){var a=g[e];var h=a.getMedia();var l=h.getType();if(l=="audio"&&this.configuration.audioCodecsFilter){var k=this.getOfferedCodecsInMediaDescription(a);var j=(this.configuration.audioCodecsFilter).split(",");this.applyCodecFiltersOnOfferedCodecs(k,j);this.updateMediaDescription(a,k,j)}else{if(l=="video"&&this.configuration.videoCodecsFilter){var b=this.getOfferedCodecsInMediaDescription(a);var d=(this.configuration.videoCodecsFilter).split(",");this.applyCodecFiltersOnOfferedCodecs(b,d);this.updateMediaDescription(a,b,d)}}}}catch(c){console.error("WebRTCommCall:applyConfiguredCodecFilterOnSessionDescription(): catched exception, exception:"+c);throw c}}else{throw"WebRTCommCall:applyConfiguredCodecFilterOnSessionDescription(): bad arguments"}};WebRTCommCall.prototype.getOfferedCodecsInMediaDescription=function(a){console.debug("WebRTCommCall:getOfferedCodecsInMediaDescription()");if(a instanceof MediaDescription){var i=a.getMedia().getFormats(false);var f={};for(var h=0;h<i.length;h++){var o=i[h];console.debug("WebRTCommCall:getOfferedCodecsInMediaDescription(): payloadType="+o);console.debug("WebRTCommCall:getOfferedCodecsInMediaDescription(): this.codecNames[payloadType]="+this.codecNames[o]);f[o]=this.codecNames[o]}var e=a.getAttributes();for(var g=0;g<e.length;g++){var l=e[g];console.debug("WebRTCommCall:getOfferedCodecsInMediaDescription(): attributField.getName()="+l.getName());if(l.getName()=="rtpmap"){try{var d=l.getValue();var n=d.split(" ");var o=n[0];var b=n[1];var m=b.split("/");var p=m[0];f[o]=p.toUpperCase();console.debug("WebRTCommCall:getOfferedCodecsInMediaDescription(): payloadType="+o);console.debug("WebRTCommCall:getOfferedCodecsInMediaDescription(): codecName="+p)}catch(c){console.error("WebRTCommCall:getOfferedCodecsInMediaDescription(): rtpmap/fmtp format not supported")}}}return f}else{throw"WebRTCommCall:getOfferedCodecsInMediaDescription(): bad arguments"}};WebRTCommCall.prototype.applyCodecFiltersOnOfferedCodecs=function(e,d){console.debug("WebRTCommCall:applyCodecFiltersOnOfferedCodecs()");if(typeof(e)=="object"&&d instanceof Array){for(var b in e){var a=false;for(var c=0;c<d.length;c++){if(e[b]==d[c]){a=true;break}}if(a==false){delete (e[b])}}}else{throw"WebRTCommCall:applyCodecFiltersOnOfferedCodecs(): bad arguments"}};WebRTCommCall.prototype.updateMediaDescription=function(a,n,h){console.debug("WebRTCommCall:updateMediaDescription()");if(a instanceof MediaDescription&&typeof(n)=="object"&&h instanceof Array){var f=new Array();for(var l=0;l<h.length;l++){for(var j in n){if(n[j]==h[l]){f.push(j);break}}}a.getMedia().setFormats(f);var b=new Array();var e=a.getAttributes();for(var g=0;g<e.length;g++){var m=e[g];console.debug("WebRTCommCall:updateMediaDescription(): attributField.getName()="+m.getName());if(m.getName()=="rtpmap"||m.getName()=="fmtp"){try{var d=m.getValue();var p=d.split(" ");var o=p[0];if(n[o]!=undefined){b.push(m)}}catch(c){console.error("WebRTCommCall:updateMediaDescription(): rtpmap/fmtp format not supported")}}else{b.push(m)}}a.setAttributes(b)}else{throw"WebRTCommCall:updateMediaDescription(): bad arguments"}};WebRTCommCall.prototype.removeMediaDescription=function(f,h){console.debug("WebRTCommCall:removeMediaDescription()");if(f instanceof SessionDescription){try{var e=f.getMediaDescriptions(false);for(var d=0;d<e.length;d++){var c=e[d];var g=c.getMedia();var a=g.getType();if(a==h){e.remove(d);break}}}catch(b){console.error("WebRTCommCall:removeMediaDescription(): catched exception, exception:"+b);throw b}}else{throw"WebRTCommCall:removeMediaDescription(): bad arguments"}};WebRTCommClient=function(a){if(typeof a=="object"){this.id="WebRTCommClient"+Math.floor(Math.random()*2147483648);console.debug("WebRTCommClient:WebRTCommClient():this.id="+this.id);this.eventListener=a;this.configuration=undefined;this.connector=undefined;this.closePendingFlag=false}else{throw"WebRTCommClient:WebRTCommClient(): bad arguments"}};WebRTCommClient.prototype.SIP="SIP";WebRTCommClient.prototype.isOpened=function(){if(this.connector){return this.connector.isOpened()}else{return false}};WebRTCommClient.prototype.getConfiguration=function(){return this.configuration};WebRTCommClient.prototype.open=function(a){console.debug("WebRTCommClient:open(): configuration="+JSON.stringify(a));if(typeof(a)=="object"){if(this.isOpened()==false){if(this.checkConfiguration(a)==true){this.configuration=a;if(a.communicationMode==WebRTCommClient.prototype.SIP){this.connector=new PrivateJainSipClientConnector(this);this.connector.open(this.configuration.sip)}}else{console.error("WebRTCommClient:open(): bad configuration");throw"WebRTCommClient:open(): bad configuration"}}else{console.error("WebRTCommClient:open(): bad state, unauthorized action");throw"WebRTCommClient:open(): bad state, unauthorized action"}}else{console.error("WebRTCommClient:open(): bad argument, check API documentation");throw"WebRTCommClient:open(): bad argument, check API documentation"}};WebRTCommClient.prototype.close=function(){console.debug("WebRTCommClient:close()");if(this.isOpened()){try{this.closePendingFlag=true;this.connector.close()}catch(a){console.error("WebRTCommClient:close(): catched exception:"+a);this.closePendingFlag=false;this.connector=undefined;if(this.eventListener.onWebRTCommClientClosedEvent!=undefined){var b=this;setTimeout(function(){try{b.eventListener.onWebRTCommClientClosedEvent(b)}catch(c){console.error("WebRTCommClient:onWebRTCommClientClosed(): catched exception in event listener:"+c)}},1)}}}};WebRTCommClient.prototype.call=function(b,c){console.debug("WebRTCommClient:call():calleePhoneNumber="+b);console.debug("WebRTCommClient:call():callConfiguration="+JSON.stringify(c));try{if(typeof(b)=="string"&&typeof(c)=="object"){if(this.isOpened()){var d=new WebRTCommCall(this);d.connector=this.connector.createPrivateCallConnector(d);d.id=d.connector.getId();d.open(b,c);return d}else{console.error("WebRTCommClient:call(): bad state, unauthorized action");throw"WebRTCommClient:call(): bad state, unauthorized action"}}else{console.error("WebRTCommClient:call(): bad argument, check API documentation");throw"WebRTCommClient:call(): bad argument, check API documentation"}}catch(a){console.error("WebRTCommClient:call(): catched exception:"+a);throw a}};WebRTCommClient.prototype.checkConfiguration=function(b){console.debug("WebRTCommClient:checkConfiguration(): configuration="+JSON.stringify(b));var a=true;if(b.communicationMode!=undefined){if(b.communicationMode==WebRTCommClient.prototype.SIP){}else{a=false;console.error("WebRTCommClient:checkConfiguration(): unsupported communicationMode")}}else{a=false;console.error("WebRTCommClient:checkConfiguration(): missing configuration parameter communicationMode")}return a};WebRTCommClient.prototype.onPrivateClientConnectorOpenedEvent=function(){console.debug("WebRTCommClient:onPrivateClientConnectorOpenedEvent()");if(this.eventListener.onWebRTCommClientOpenedEvent!=undefined){var a=this;setTimeout(function(){try{a.eventListener.onWebRTCommClientOpenedEvent()}catch(b){console.error("WebRTCommClient:onPrivateClientConnectorOpenedEvent(): catched exception in event listener:"+b)}},1)}};WebRTCommClient.prototype.onPrivateClientConnectorOpenErrorEvent=function(a){console.debug("WebRTCommClient:onPrivateClientConnectorOpenErrorEvent():error:"+a);try{this.close()}catch(b){}if(this.eventListener.onWebRTCommClientOpenErrorEvent!=undefined){var c=this;setTimeout(function(){try{c.eventListener.onWebRTCommClientOpenErrorEvent(a)}catch(d){console.error("WebRTCommClient:onPrivateClientConnectorOpenErrorEvent(): catched exception in event listener:"+d)}},1)}};WebRTCommClient.prototype.onPrivateClientConnectorClosedEvent=function(){console.debug("WebRTCommClient:onPrivateClientConnectorClosedEvent()");var c=this.isOpened()||this.closePendingFlag;try{if(this.closePendingFlag==false){this.close()}else{this.connector=undefined}}catch(a){}if(c&&this.eventListener.onWebRTCommClientClosedEvent!=undefined){var b=this;setTimeout(function(){try{b.eventListener.onWebRTCommClientClosedEvent()}catch(d){console.error("WebRTCommClient:onPrivateClientConnectorClosedEvent(): catched exception in event listener:"+d)}},1)}else{if(!c&&this.eventListener.onWebRTCommClientOpenErrorEvent!=undefined){var b=this;setTimeout(function(){try{b.eventListener.onWebRTCommClientOpenErrorEvent("Connection to WebRTCommServer has failed")}catch(d){console.error("WebRTCommClient:onWebRTCommClientOpenErrorEvent(): catched exception in event listener:"+d)}},1)}}};WebRTCommClientEventListenerInterface=function(){};WebRTCommClientEventListenerInterface.prototype.onWebRTCommClientOpenedEvent=function(){throw"WebRTCommClientEventListenerInterface:onWebRTCommClientOpenedEvent(): not implemented;"};WebRTCommClientEventListenerInterface.prototype.onWebRTCommClientOpenErrorEvent=function(a){throw"WebRTCommClientEventListenerInterface:onWebRTCommClientOpenErrorEvent(): not implemented;"};WebRTCommClientEventListenerInterface.prototype.onWebRTCommClientClosedEvent=function(a){throw"WebRTCommClientEventListenerInterface:onWebRTCommClientClosedEvent(): not implemented;"};WebRTCommCallEventListenerInterface=function(){};WebRTCommCallEventListenerInterface.prototype.onWebRTCommCallOpenedEvent=function(a){throw"WebRTCommCallEventListenerInterface:onWebRTCommCallOpenedEvent(): not implemented;"};WebRTCommCallEventListenerInterface.prototype.onWebRTCommCallInProgressEvent=function(a){throw"WebRTCommCallEventListenerInterface:onWebRTCommCallInProgressEvent(): not implemented;"};WebRTCommCallEventListenerInterface.prototype.onWebRTCommCallOpenErrorEvent=function(b,a){throw"WebRTCommCallEventListenerInterface:onWebRTCommCallOpenErrorEvent(): not implemented;"};WebRTCommCallEventListenerInterface.prototype.onWebRTCommCallRingingEvent=function(a){throw"WebRTCommCallEventListenerInterface:onWebRTCommCallRingingEvent(): not implemented;"};WebRTCommCallEventListenerInterface.prototype.onWebRTCommCallRingingBackEvent=function(a){throw"WebRTCommCallEventListenerInterface:onWebRTCommCallRingingBackEvent(): not implemented;"};WebRTCommCallEventListenerInterface.prototype.onWebRTCommCallHangupEvent=function(a){throw"WebRTCommCallEventListenerInterface:onWebRTCommCallHangupEvent(): not implemented;"};WebRTCommCallEventListenerInterface.prototype.onWebRTCommCallMessageEvent=function(a,b){throw"WebRTCommCallEventListenerInterface:onWebRTCommCallMessageEvent(): not implemented;"};